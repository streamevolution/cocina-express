<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cocina Express - V2 Admin</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Arimo:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Tinos:wght@700&display=swap');

        body { background-color: #f8fafc; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        
        /* Loader */
        #loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: opacity 0.8s ease-out, visibility 0.8s; }
        .loader-icon-bg { background: white; width: 100px; height: 100px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .progress-container { width: 200px; height: 6px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress-bar { height: 100%; width: 0%; background: white; border-radius: 10px; animation: load 2.5s ease-in-out forwards; }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
        .app-loaded { overflow: auto; }
        .fade-out { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Estilos Receta */
        .barcode { height: 45px; width: 220px; margin: 0 auto; background: linear-gradient(90deg, #000 1px, transparent 1px, transparent 2px, #000 2px, #000 4px, transparent 4px, transparent 5px, #000 5px, #000 6px, transparent 6px, transparent 8px, #000 8px, #000 11px, transparent 11px, transparent 12px, #000 12px, #000 13px, transparent 13px, transparent 15px, #000 15px, #000 17px, transparent 17px, transparent 19px, #000 19px, #000 20px, transparent 20px, transparent 21px, #000 21px, #000 24px, transparent 24px, transparent 26px, #000 26px, #000 27px, transparent 27px, transparent 29px, #000 29px, #000 31px, transparent 31px, transparent 33px, #000 33px, #000 36px, transparent 36px, transparent 38px, #000 38px, #000 39px, transparent 39px, transparent 40px, #000 40px, #000 43px, transparent 43px, transparent 44px, #000 44px, #000 45px, transparent 45px, transparent 47px, #000 47px, #000 50px, transparent 50px, transparent 51px, #000 51px, #000 53px, transparent 53px, transparent 55px, #000 55px, #000 58px, transparent 58px, transparent 60px, #000 60px, #000 61px, transparent 61px, transparent 63px, #000 63px, #000 65px, transparent 65px, transparent 67px, #000 67px, #000 70px, transparent 70px, transparent 72px, #000 72px, #000 74px, transparent 74px, transparent 76px, #000 76px, #000 77px, transparent 77px, transparent 79px, #000 79px, #000 82px, transparent 82px, transparent 83px, #000 83px, #000 84px, transparent 84px, transparent 86px, #000 86px, #000 88px, transparent 88px, transparent 90px, #000 90px, #000 93px, transparent 93px, transparent 94px); background-size: 94px 100%; }
        .pt-box { padding: 2px 4px; line-height: 1.1; font-size: 9px; width: 100%; }
        .double-box { border: 4px double #000; background: white; }
        .pt-label { font-weight: 900; font-size: 9px; margin-right: 3px; }
        .pt-val { font-weight: 700; font-size: 10px; }
        .doctor-stamp { border: 3px solid #003366; color: #003366; padding: 4px 6px; display: flex; align-items: center; gap: 6px; font-family: 'Arial Black', sans-serif; font-weight: 900; text-transform: uppercase; line-height: 1.1; font-size: 9px; transform: rotate(-12deg); max-width: 260px; filter: url(#stamp-texture); mix-blend-mode: multiply; opacity: 0.95; }
        .stamp-logo { height: 35px; width: auto; filter: grayscale(100%) sepia(100%) hue-rotate(190deg) saturate(1000%) brightness(40%) contrast(120%); }
        .svg-filters { position: absolute; width: 0; height: 0; overflow: hidden; }
        @media print { @page { margin: 0; size: letter; } body { background: white; -webkit-print-color-adjust: exact; } .no-print { display: none !important; } .print-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 0.5cm !important; display: block; background: white !important; } .paper { box-shadow: none !important; margin: 0 auto !important; border: none !important; } }
    </style>
</head>
<body>
    <div id="loader-wrapper"><div class="loader-content"><div class="loader-icon-bg"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z"/><line x1="6" y1="17" x2="18" y2="17"/></svg></div><h1 class="text-4xl font-extrabold mb-1">Cocina Express</h1><p class="text-sm opacity-90 tracking-widest uppercase">Conectando...</p><div class="progress-container"><div class="progress-bar"></div></div></div></div>
    <svg class="svg-filters" xmlns="http://www.w3.org/2000/svg"><defs><filter id="stamp-texture"><feTurbulence type="fractalNoise" baseFrequency="0.5" numOctaves="1" result="noise" /><feColorMatrix type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.3 0.7" in="noise" result="alphaNoise" /><feComposite operator="in" in="SourceGraphic" in2="alphaNoise" /></filter></defs></svg>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ==========================================
        // ICONOS SVG MANUALES
        // ==========================================
                        const ICONS = {
            'utensils': <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
            'users': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
            'history': <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l3 3"/></>,
            'arrow-left': <><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>,
            'log-out': <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            'plus': <><path d="M5 12h14"/><path d="M12 5v14"/></>,
            'shield': <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>,
            'chevron-right': <><path d="m9 18 6-6-6-6"/></>,
            'file-heart': <><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><path d="M14 2v6h6"/><path d="M10.29 10.7a2.43 2.43 0 0 0-2.66-.52c-.29.12-.56.31-.78.53l-.35.34-.35-.34a2.43 2.43 0 0 0-2.66-.52 2.43 2.43 0 0 0-1.55 2.53c0 1.6 3.12 3.86 4.56 5.25 1.44-1.39 4.56-3.65 4.56-5.25a2.42 2.42 0 0 0-1.55-2.53z"/></>,
            'baby': <><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5c-.8 0-1.5-.4-1.5-1"/></>,
            'receipt': <><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 17V7"/></>,
            'edit-2': <><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>,
            'trash': <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>,
            'log-in': <><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>,
            'user-plus': <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></>,
            'edit-3': <><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>,
            'box': <><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></>,
            'plus-circle': <><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>,
            'briefcase': <><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
            'dollar-sign': <><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
            'bar-chart': <><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></>,
            'lock': <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            'tv': <><rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></>,
            'x': <><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>, 
            'copy': <><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></>, 
            'alert-circle': <><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>
        };


        const Icon = ({ name, className, size = 24 }) => {
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {ICONS[name] || null}
                </svg>
            );
        };

        // ==========================================
        // CONSTANTES DE CONFIGURACI√ìN
        // ==========================================
        
        // 10 Colores predefinidos (Fondo + Texto + Anillo para selecci√≥n)
        const COLOR_OPTIONS = [
            { id: 'orange', label: 'Naranja', bg: 'bg-orange-100', text: 'text-orange-600', ring: 'ring-orange-500' },
            { id: 'blue',   label: 'Azul',    bg: 'bg-blue-100',   text: 'text-blue-600',   ring: 'ring-blue-500' },
            { id: 'green',  label: 'Verde',   bg: 'bg-green-100',  text: 'text-green-600',  ring: 'ring-green-500' },
            { id: 'red',    label: 'Rojo',    bg: 'bg-red-100',    text: 'text-red-600',    ring: 'ring-red-500' },
            { id: 'purple', label: 'Morado',  bg: 'bg-purple-100', text: 'text-purple-600', ring: 'ring-purple-500' },
            { id: 'pink',   label: 'Rosa',    bg: 'bg-pink-100',   text: 'text-pink-600',   ring: 'ring-pink-500' },
            { id: 'indigo', label: 'Indigo',  bg: 'bg-indigo-100', text: 'text-indigo-600', ring: 'ring-indigo-500' },
            { id: 'teal',   label: 'Turquesa',bg: 'bg-teal-100',   text: 'text-teal-600',   ring: 'ring-teal-500' },
            { id: 'yellow', label: 'Amarillo',bg: 'bg-yellow-100', text: 'text-yellow-600', ring: 'ring-yellow-500' },
            { id: 'gray',   label: 'Gris',    bg: 'bg-slate-200',  text: 'text-slate-600',  ring: 'ring-slate-500' }
        ];

        // Obtener las claves de los iconos disponibles para la cuadr√≠cula de selecci√≥n
        const AVAILABLE_ICONS = Object.keys(ICONS);

        // ==========================================
        // 1. CONFIGURACI√ìN E INICIALIZACI√ìN FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDkGcUsxLymeAqNXPEzPc2adAN44mM7734",
            authDomain: "cocina-express-b5a72.firebaseapp.com",
            projectId: "cocina-express-b5a72",
            storageBucket: "cocina-express-b5a72.firebasestorage.app",
            messagingSenderId: "643149431858",
            appId: "1:643149431858:web:6a404dddc8237d8710e82b"
        };

        const ADMIN_EMAIL = "mrandroidtutorialeshd@gmail.com";
        const appId = "mi-cocina-v1";

        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = app.auth();
            db = app.firestore();
            console.log("Firebase iniciado");
        } catch (error) {
            console.error("Error iniciando Firebase:", error);
        }

        // ==========================================
        // 2. COMPONENTES
        // ==========================================

        const AuthScreen = ({ onLoginSuccess }) => {
            const [isRegistering, setIsRegistering] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setMessage('');
                try {
                    if (isRegistering) {
                        const cred = await auth.createUserWithEmailAndPassword(email, password);
                        await cred.user.sendEmailVerification();
                        await db.collection('users').doc(cred.user.uid).set({ 
                            balance: 0, 
                            earnings: 0, 
                            email: email,
                            role: 'user',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setMessage("‚úÖ Cuenta creada. Verifica tu correo."); setIsRegistering(false);
                    } else {
                        const cred = await auth.signInWithEmailAndPassword(email, password);
                        if (cred.user.emailVerified || cred.user.email === ADMIN_EMAIL) onLoginSuccess(cred.user);
                        else { setMessage("‚ö†Ô∏è Verifica tu correo."); auth.signOut(); }
                    }
                } catch (err) { setError(err.message); }
            };

            return (
                <div className="min-h-screen bg-orange-50 flex items-center justify-center p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md border border-orange-100">
                        <div className="text-center mb-6">
                            <div className="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600">
                                <Icon name={isRegistering ? "user-plus" : "log-in"} className="text-orange-600" size={32} />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800">{isRegistering ? "Crear Cuenta" : "Iniciar Sesi√≥n"}</h2>
                        </div>
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm border border-red-100">{error}</div>}
                        {message && <div className="bg-green-50 text-green-700 p-3 rounded mb-4 text-sm border border-green-100">{message}</div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="email" required className="w-full border p-3 rounded-xl" placeholder="Correo" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" required className="w-full border p-3 rounded-xl" placeholder="Contrase√±a" value={password} onChange={e=>setPassword(e.target.value)} />
                            <button className="w-full bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 transition">{isRegistering?"Registrarse":"Entrar"}</button>
                        </form>
                        <div className="mt-6 text-center"><button onClick={()=>{setIsRegistering(!isRegistering);setError('');setMessage('')}} className="text-orange-600 font-bold text-sm hover:underline">{isRegistering?"Ya tengo cuenta":"Crear cuenta nueva"}</button></div>
                    </div>
                </div>
            );
        };

                                                                                                                                                                const AdminPanel = ({ onNavigate }) => {
            const [view, setView] = useState('users'); 
            const [users, setUsers] = useState([]);
            const [requests, setRequests] = useState([]); 
            const [serviceRequests, setServiceRequests] = useState([]); 
            const [services, setServices] = useState([]);
            const [adminStats, setAdminStats] = useState([]); 
            const [allSales, setAllSales] = useState([]); 
            
            // Estados para Servicios
            const [editingId, setEditingId] = useState(null); 
            const [showServiceForm, setShowServiceForm] = useState(false);
            const [roleMenuId, setRoleMenuId] = useState(null);

            // Estados para Configuraci√≥n de Roles (NUEVO)
            const [showRoleConfig, setShowRoleConfig] = useState(false);
            const [roleCosts, setRoleCosts] = useState({ vip: '', reseller: '', leader: '' });

            // Estados para Estad√≠sticas
            const [showStatForm, setShowStatForm] = useState(false);
            const [newStatData, setNewStatData] = useState({ title: '', linkedServiceName: '' });

            const [formData, setFormData] = useState({
                name: '', description: '', deliveryTime: '', icon: 'briefcase', colorId: 'orange',
                priceClient: '', priceVip: '', priceReseller: '', priceLeader: '',
                order: '', category: 'clones'
            });

            const ROLES = ['Cliente', 'Cliente Vip', 'Revendedor', 'L√≠der'];
            const MASTER_ADMIN = "mrandroidtutorialeshd@gmail.com";

            useEffect(() => { loadData(); }, [view]);

            const loadData = async () => {
                if(view === 'users') {
                    const snap = await db.collection('users').orderBy('createdAt', 'desc').get();
                    setUsers(snap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                } else if(view === 'payments') {
                    const snap = await db.collection('recharge_requests').where('status','==','pending').get();
                    setRequests(snap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                } else if(view === 'service_requests') { 
                    const snap = await db.collection('service_requests').orderBy('timestamp', 'desc').get();
                    setServiceRequests(snap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                } else if(view === 'stats') {
                    const statsSnap = await db.collection('admin_stats_config').get();
                    setAdminStats(statsSnap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                    const salesSnap = await db.collection('purchased_services').get();
                    setAllSales(salesSnap.docs.map(doc => doc.data()));
                    const servicesSnap = await db.collection('custom_services').get();
                    setServices(servicesSnap.docs.map(doc => ({id: doc.id, ...doc.data()})));
                } else if(view === 'services') {
                    const snap = await db.collection('custom_services').get();
                    let items = snap.docs.map(doc => ({id: doc.id, isActive: true, ...doc.data()}));
                    items.sort((a, b) => (a.order || 0) - (b.order || 0));
                    setServices(items);
                    
                    // Cargar configuraci√≥n de precios de roles
                    const configSnap = await db.collection('app_config').doc('role_prices').get();
                    if (configSnap.exists) setRoleCosts(configSnap.data());
                }
            };

            // --- L√ìGICA DE ROLES (NUEVO) ---
            const handleSaveRoleCosts = async () => {
                try {
                    await db.collection('app_config').doc('role_prices').set({
                        vip: parseFloat(roleCosts.vip) || 0,
                        reseller: parseFloat(roleCosts.reseller) || 0,
                        leader: parseFloat(roleCosts.leader) || 0
                    });
                    alert("‚úÖ Costos de jerarqu√≠a actualizados correctamente.");
                    setShowRoleConfig(false);
                } catch (e) { alert("Error al guardar configuraci√≥n: " + e.message); }
            };

            const handleDirectRecharge = async (u) => { const amount = prompt(`Monto a CARGAR (Sumar) a ${u.email}:`); const val = parseFloat(amount); if(!isNaN(val) && val > 0) { try { await db.collection('users').doc(u.id).update({ balance: firebase.firestore.FieldValue.increment(val) }); alert(`‚úÖ Se cargaron $${val} a ${u.email}`); loadData(); } catch(e) { alert("Error"); } } };
            const handleEditBalance = async (u) => { const newBal = prompt(`‚ö†Ô∏è ESTABLECER saldo exacto para ${u.email}:`, u.balance); if(newBal !== null) { await db.collection('users').doc(u.id).update({balance: parseFloat(newBal)}); loadData(); } };
            const handleSelectRole = async (userId, newRole) => { try { await db.collection('users').doc(userId).update({ membership: newRole }); setRoleMenuId(null); loadData(); } catch (e) { alert("Error"); } };
            const handleToggleSuspend = async (u) => { if(confirm(u.suspended ? "¬øReactivar?" : "¬øSUSPENDER?")) { await db.collection('users').doc(u.id).update({ suspended: !u.suspended }); loadData(); } };
            const handleDeleteUser = async (id) => { if(confirm("‚õî ¬øELIMINAR USUARIO?")) { await db.collection('users').doc(id).delete(); loadData(); } };
            
            // BORRAR HISTORIAL COMPLETO
            const handleDeleteHistory = async (u) => {
                if(auth.currentUser.email !== "mrandroidtutorialeshd@gmail.com") return alert("‚õî ACCESO DENEGADO");
                if (!confirm(`‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nSe eliminar√° TODO de ${u.email}:\n- Historial de Recargas\n- Compras de Servicios\n- TODOS los PDF Generados\n\nEsta acci√≥n no se puede deshacer.`)) return;
                try {
                    const collections = ['recharge_requests', 'purchased_services', 'service_requests', 'recetas_imss', 'notas_remision', 'ine_history', 'actas_nacimiento', 'curp_history', 'incapacidades_history', 'cfe_history', 'cert_secundaria_history'];
                    let totalDeleted = 0;
                    for (const colName of collections) {
                        const snapshot = await db.collection(colName).where('userId', '==', u.id).get();
                        if (!snapshot.empty) {
                            const batch = db.batch();
                            snapshot.docs.forEach(doc => { batch.delete(doc.ref); totalDeleted++; });
                            await batch.commit();
                        }
                    }
                    if (totalDeleted > 0) alert(`‚úÖ Limpieza Exitosa.\nSe eliminaron ${totalDeleted} documentos y registros.`); else alert("El usuario no ten√≠a registros para borrar.");
                    loadData();
                } catch (e) { console.error(e); alert("Error al eliminar: " + e.message); }
            };

            const handleAttachLink = async (req) => {
                const link = prompt("üìÇ Pegue aqu√≠ el link de descarga:");
                if(!link) return;
                try {
                    const batch = db.batch();
                    const reqRef = db.collection('service_requests').doc(req.id);
                    batch.update(reqRef, { downloadUrl: link });
                    if (req.historyId) {
                        const histRef = db.collection('purchased_services').doc(req.historyId);
                        batch.update(histRef, { downloadUrl: link });
                    }
                    await batch.commit(); loadData(); alert("‚úÖ Documento adjuntado.");
                } catch(e) { alert("Error al adjuntar: " + e.message); }
            };

            const handleCompleteServiceRequest = async (req) => {
                if(confirm("¬øMarcar solicitud como COMPLETADA y notificar en historial?")) {
                    try {
                        const batch = db.batch();
                        if (req.historyId) {
                            const histRef = db.collection('purchased_services').doc(req.historyId);
                            batch.update(histRef, { serviceName: req.serviceName + " (Finalizado)", status: 'completed' });
                        }
                        const reqRef = db.collection('service_requests').doc(req.id);
                        batch.delete(reqRef);
                        await batch.commit(); loadData(); alert("‚úÖ Solicitud finalizada.");
                    } catch(e) { alert("Error: " + e.message); }
                }
            };

            const handleSaveStat = async (e) => { e.preventDefault(); if(!newStatData.title || !newStatData.linkedServiceName) return alert("Llena todos los campos"); try { await db.collection('admin_stats_config').add({ title: newStatData.title, linkedServiceName: newStatData.linkedServiceName, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); setNewStatData({ title: '', linkedServiceName: '' }); setShowStatForm(false); loadData(); } catch(e) { alert("Error"); } };
            const handleDeleteStat = async (id) => { if(confirm("¬øEliminar?")) { await db.collection('admin_stats_config').doc(id).delete(); loadData(); } };
            const getServiceCount = (serviceName) => allSales.filter(sale => sale.serviceName === serviceName).length;

            const handleToggleStatus = async (service) => { try { await db.collection('custom_services').doc(service.id).update({ isActive: !service.isActive }); loadData(); } catch (e) { console.error(e); } };
            const resetForm = () => { setFormData({ name: '', description: '', deliveryTime: '', icon: 'briefcase', colorId: 'orange', priceClient: '', priceVip: '', priceReseller: '', priceLeader: '', order: '', category: 'clones' }); setEditingId(null); setShowServiceForm(false); };
            
            const handleSaveService = async (e) => {
                e.preventDefault();
                const { name, description, deliveryTime, icon, colorId, priceClient, priceVip, priceReseller, priceLeader, order, category } = formData;
                if(!name || !description) return alert("Faltan datos b√°sicos");
                try {
                    const targetCategory = category || 'clones';
                    const categoryServices = services.filter(s => (s.category || 'clones') === targetCategory);
                    const nextOrder = categoryServices.length > 0 ? Math.max(...categoryServices.map(s => s.order || 0)) + 1 : 1;
                    const payload = { 
                        name, description, deliveryTime: deliveryTime||'Inmediato', icon, colorId,
                        priceClient: priceClient || '0', priceVip: priceVip || priceClient || '0', priceReseller: priceReseller || priceClient || '0', priceLeader: priceLeader || priceClient || '0',
                        order: order ? parseInt(order) : nextOrder, category: targetCategory, isActive: true 
                    };
                    if(editingId) { const { isActive, ...updateData } = payload; await db.collection('custom_services').doc(editingId).update({...updateData, updatedAt: firebase.firestore.FieldValue.serverTimestamp()}); } 
                    else { await db.collection('custom_services').add({...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); }
                    alert("Servicio guardado"); resetForm(); loadData();
                } catch(e) { alert("Error al guardar"); }
            };

            const handleEditServiceClick = (s) => { 
                setEditingId(s.id); setShowServiceForm(true); 
                setFormData({ name: s.name, description: s.description, deliveryTime: s.deliveryTime||'', icon: s.icon||'briefcase', colorId: s.colorId||'orange', priceClient: s.priceClient || s.price || '', priceVip: s.priceVip || s.price || '', priceReseller: s.priceReseller || s.price || '', priceLeader: s.priceLeader || s.price || '', order: s.order || '', category: s.category || 'clones' }); 
                setTimeout(() => { document.getElementById('service-form-container')?.scrollIntoView({ behavior: 'smooth' }); }, 100); 
            };
            const handleDeleteService = async (id) => { if(confirm("¬øBorrar servicio?")) { await db.collection('custom_services').doc(id).delete(); loadData(); } };
            const processPayment = async (req, approved) => { try { const batch = db.batch(); batch.update(db.collection('recharge_requests').doc(req.id), { status: approved ? 'approved' : 'rejected' }); if(approved) batch.update(db.collection('users').doc(req.userId), { balance: firebase.firestore.FieldValue.increment(req.amount) }); await batch.commit(); alert(approved?"Aprobado":"Rechazado"); loadData(); } catch(e){alert("Error");} };

            const ServiceList = ({ title, items, colorClass, iconName }) => (
                <div className="mb-8"><h3 className={`text-xs font-bold ${colorClass} uppercase tracking-wider mb-3 ml-2 flex items-center gap-2`}><Icon name={iconName} size={14} /> {title}</h3>{items.length === 0 && <p className="text-xs text-slate-400 ml-2 italic">No hay servicios aqu√≠.</p>}{items.map((s) => { const colorTheme = COLOR_OPTIONS.find(c => c.id === s.colorId) || COLOR_OPTIONS[0]; const isActive = s.isActive !== false; return ( <div key={s.id} className={`bg-white p-3 rounded-2xl mb-3 flex justify-between items-center shadow-sm border border-slate-100 transition hover:shadow-md ${editingId === s.id ? 'ring-2 ring-blue-400' : ''} ${!isActive ? 'opacity-70 grayscale-[0.8]' : ''}`}><div className="flex items-center gap-3 overflow-hidden flex-1"><div className="flex items-center justify-center w-8 h-8 rounded-full bg-slate-50 text-slate-500 text-xs font-bold border border-slate-100">#{s.order}</div><div className={`${colorTheme.bg} p-2.5 rounded-xl ${colorTheme.text} flex-shrink-0`}><Icon name={s.icon || 'briefcase'} size={18} /></div><div className="min-w-0"><h4 className="text-sm font-bold text-slate-800 truncate">{s.name}</h4><div className="flex items-center gap-2 mt-0.5">{s.priceClient && <span className="text-[10px] font-bold bg-green-50 text-green-700 px-1.5 py-0.5 rounded border border-green-100">Base: ${s.priceClient}</span>}</div></div></div><div className="flex items-center gap-2 ml-2"><div className="flex flex-col items-center gap-1 border-r border-slate-100 pr-3 mr-1"><button onClick={() => handleToggleStatus(s)} className={`w-8 h-4 rounded-full p-0.5 flex items-center transition-colors ${isActive ? 'bg-green-500 justify-end' : 'bg-slate-200 justify-start'}`}><div className="w-3 h-3 bg-white rounded-full shadow-sm"></div></button></div><button onClick={()=>handleEditServiceClick(s)} className="p-2 text-blue-400 hover:bg-blue-50 rounded-xl transition"><Icon name="edit-2" size={16} /></button><button onClick={()=>handleDeleteService(s.id)} className="p-2 text-red-400 hover:bg-red-50 rounded-xl transition"><Icon name="trash" size={16} /></button></div></div> ); })}</div>
            );

            const TabButton = ({ id, icon, label, badge }) => ( <button onClick={() => setView(id)} className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-200 min-w-[70px] ${view === id ? 'bg-orange-600 text-white shadow-lg scale-105' : 'bg-white text-gray-500 hover:bg-orange-50'}`}><div className="relative"><Icon name={icon} size={20} className="mb-1" />{badge > 0 && <span className="absolute -top-2 -right-3 bg-red-500 text-white text-[9px] font-bold h-4 min-w-[16px] px-1 rounded-full flex items-center justify-center border-2 border-white animate-pulse">{badge}</span>}</div><span className="text-[9px] font-bold uppercase tracking-wide">{label}</span></button> );

            return (
                <div className="min-h-screen bg-slate-100 font-sans pb-8">
                    <div className="bg-white p-6 pt-8 pb-4 shadow-sm border-b border-gray-200 sticky top-0 z-50">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3"><button onClick={()=>onNavigate('welcome')} className="bg-slate-100 p-2 rounded-full hover:bg-slate-200 transition"><Icon name="arrow-left" size={20} className="text-slate-700" /></button><div><h1 className="text-xl font-bold text-slate-900">Administraci√≥n</h1><p className="text-xs text-slate-500 font-medium">Control total del sistema</p></div></div>
                            <div className="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Icon name="shield" size={12} /> ADMIN</div>
                        </div>
                        <div className="flex justify-between gap-2 overflow-x-auto pb-2 no-scrollbar">
                            <TabButton id="users" icon="users" label="Usuarios" />
                            <TabButton id="payments" icon="dollar-sign" label="Pagos" badge={requests.length} />
                            <TabButton id="service_requests" icon="file-heart" label="Solicitudes" badge={serviceRequests.length} />
                            <TabButton id="stats" icon="bar-chart" label="Stats" />
                            <TabButton id="services" icon="briefcase" label="Servicios" />
                        </div>
                    </div>

                    <div className="px-4 py-6 pb-20 max-w-2xl mx-auto">
                        {view === 'users' && users.map(u => (
                            <div key={u.id} className={`bg-white p-5 rounded-3xl mb-4 shadow-sm border transition-all ${u.suspended ? 'border-red-300 bg-red-50' : 'border-slate-100'}`}>
                                <div className="flex justify-between items-start mb-3"><div className="flex items-center gap-3"><div className={`p-3 rounded-full ${u.suspended ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-blue-600'}`}><Icon name="users" size={20} /></div><div><div className="text-sm font-bold text-slate-900">{u.email}</div><div className="text-[10px] text-slate-400 font-mono">ID: {u.id.substring(0, 8)}...</div><div className={`mt-1 inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${u.membership === 'L√≠der' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : u.membership === 'Revendedor' ? 'bg-purple-100 text-purple-700 border-purple-200' : u.membership === 'Cliente Vip' ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{u.suspended ? 'SUSPENDIDO' : (u.membership || 'Cliente')}</div></div></div><div className="text-right"><div className="text-xs text-slate-400 font-bold uppercase">Saldo</div><div className="text-xl font-black text-slate-800">${u.balance?.toLocaleString() || 0}</div></div></div>
                                <div className="grid grid-cols-4 gap-2 mb-3"><button onClick={()=>handleEditBalance(u)} className="bg-slate-50 border border-slate-200 py-2 rounded-xl flex flex-col items-center justify-center text-slate-600 hover:bg-slate-100 transition"><Icon name="edit-2" size={16} /><span className="text-[9px] font-bold mt-1">Saldo</span></button><div className="relative"><button onClick={() => setRoleMenuId(roleMenuId === u.id ? null : u.id)} className={`w-full h-full border py-2 rounded-xl flex flex-col items-center justify-center transition ${roleMenuId === u.id ? 'bg-blue-100 border-blue-300 text-blue-700 ring-2 ring-blue-200' : 'bg-slate-50 border-slate-200 text-blue-600 hover:bg-blue-50'}`}><Icon name="user-plus" size={16} /><span className="text-[9px] font-bold mt-1">Rol</span></button>{roleMenuId === u.id && (<div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-32 bg-white rounded-xl shadow-2xl border border-slate-100 z-50 overflow-hidden animate-[slide_0.2s_ease-out]">{ROLES.map(role => (<button key={role} onClick={() => handleSelectRole(u.id, role)} className={`w-full text-center py-2.5 text-[10px] font-bold border-b border-slate-50 last:border-0 hover:bg-orange-50 transition ${u.membership === role ? 'text-orange-600 bg-orange-50' : 'text-slate-600'}`}>{role}</button>))}</div>)}</div><button onClick={()=>handleToggleSuspend(u)} className={`bg-slate-50 border border-slate-200 py-2 rounded-xl flex flex-col items-center justify-center hover:bg-slate-100 transition ${u.suspended ? 'text-green-600' : 'text-orange-500'}`}><Icon name="lock" size={16} /><span className="text-[9px] font-bold mt-1">{u.suspended ? 'Activar' : 'Susp.'}</span></button><button onClick={()=>handleDeleteUser(u.id)} className="bg-slate-50 border border-slate-200 py-2 rounded-xl flex flex-col items-center justify-center text-red-500 hover:bg-red-50 transition"><Icon name="trash" size={16} /><span className="text-[9px] font-bold mt-1">Borrar</span></button></div>
                                <div className="flex gap-2"><button onClick={()=>handleDirectRecharge(u)} className="flex-1 bg-[#dcfce7] text-[#166534] py-3 rounded-2xl font-bold text-sm border border-[#bbf7d0] hover:bg-[#bbf7d0] transition shadow-sm flex items-center justify-center gap-2"><Icon name="plus-circle" size={18} />Cargar Saldo</button><button onClick={()=>handleDeleteHistory(u)} className="w-1/3 bg-red-100 text-red-600 py-3 rounded-2xl font-bold text-[10px] border border-red-200 hover:bg-red-200 transition shadow-sm flex items-center justify-center gap-1 active:scale-95"><Icon name="history" size={16} /> Limpiar Hist.</button></div>
                            </div>
                        ))}

                        {view === 'payments' && (requests.length === 0 ? <div className="text-center py-10 opacity-50"><Icon name="box" size={48} className="mx-auto mb-2" /><p>No hay pagos pendientes</p></div> : requests.map(req => ( <div key={req.id} className="bg-white p-4 rounded-2xl mb-3 shadow-sm border-l-4 border-orange-500"><div className="flex justify-between mb-2"><span className="text-sm font-bold text-slate-800">{req.email}</span><span className="text-green-600 font-bold bg-green-50 px-2 rounded text-sm">+${req.amount}</span></div><div className="flex gap-2"><button onClick={()=>processPayment(req,true)} className="flex-1 bg-green-500 text-white text-xs py-2 rounded-xl font-bold hover:bg-green-600 shadow-sm shadow-green-200">Aprobar</button><button onClick={()=>processPayment(req,false)} className="flex-1 bg-red-500 text-white text-xs py-2 rounded-xl font-bold hover:bg-red-600 shadow-sm shadow-red-200">Rechazar</button></div></div> )))}

                        {view === 'service_requests' && (
                            serviceRequests.length === 0 ? <div className="text-center py-10 opacity-50"><Icon name="file-heart" size={48} className="mx-auto mb-2" /><p>No hay solicitudes pendientes</p></div> : serviceRequests.map(req => (
                                <div key={req.id} className="bg-white p-4 rounded-2xl mb-3 shadow-sm border border-slate-100 animate-[slide_0.2s_ease-out]">
                                    <div className="flex justify-between items-start mb-2">
                                        <div><span className="text-xs font-bold text-orange-600 uppercase tracking-wide block mb-1">{req.serviceName}</span><span className="text-sm font-bold text-slate-800 block">{req.userEmail}</span></div>
                                        <div className="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-xs font-bold border border-green-200">${req.cost}</div>
                                    </div>
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-3"><p className="text-[10px] text-slate-400 font-bold uppercase mb-1">DATOS DEL DOCUMENTO:</p><p className="text-xs font-mono font-bold text-slate-800 tracking-wide break-words">{req.targetCurp}</p></div>
                                    {req.downloadUrl && <div className="bg-blue-50 text-blue-700 text-xs p-2 rounded-lg mb-3 border border-blue-200 flex items-center gap-2"><Icon name="briefcase" size={14} /> Link adjuntado</div>}
                                    <div className="space-y-2"><button onClick={() => handleAttachLink(req)} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-blue-700 transition active:scale-95 shadow-sm shadow-blue-200"><Icon name="briefcase" size={16} /> {req.downloadUrl ? 'Editar Link Documento' : 'Adjuntar Documento (Link)'}</button><button onClick={() => handleCompleteServiceRequest(req)} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-800 transition active:scale-95 shadow-md"><Icon name="check-square" size={16} /> Marcar como Completado</button></div>
                                </div>
                            ))
                        )}

                        {view === 'stats' && (
                            <div className="space-y-4">
                                {!showStatForm && ( <button onClick={() => setShowStatForm(true)} className="w-full bg-slate-900 text-white py-3 rounded-2xl font-bold text-sm shadow-md flex items-center justify-center gap-2 hover:scale-[1.02] transition"><Icon name="plus-circle" size={18} /> Crear Nuevo Indicador</button> )}
                                {showStatForm && ( <div className="bg-white p-4 rounded-3xl shadow-sm border border-orange-100 animate-[slide_0.3s_ease-out]"><h3 className="text-xs font-bold text-slate-500 uppercase mb-3">Nuevo Indicador</h3><div className="space-y-3"><input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-orange-200" placeholder="T√≠tulo (ej. Recetas Generadas)" value={newStatData.title} onChange={e => setNewStatData({...newStatData, title: e.target.value})} /><div className="relative"><select className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-orange-200 appearance-none" value={newStatData.linkedServiceName} onChange={e => setNewStatData({...newStatData, linkedServiceName: e.target.value})}><option value="">-- Conectar a Servicio --</option>{services.map(s => (<option key={s.id} value={s.name}>{s.name} {s.isActive ? '' : '(Inactivo)'}</option>))}</select><div className="absolute right-3 top-3.5 text-slate-400 pointer-events-none"><Icon name="chevron-right" size={14} className="rotate-90" /></div></div><div className="flex gap-2"><button onClick={() => setShowStatForm(false)} className="flex-1 py-2 bg-slate-100 rounded-xl text-xs font-bold text-slate-500">Cancelar</button><button onClick={handleSaveStat} className="flex-1 py-2 bg-orange-500 text-white rounded-xl text-xs font-bold shadow-md shadow-orange-200">Guardar</button></div></div></div> )}
                                <div className="grid grid-cols-2 gap-4">{adminStats.map(stat => ( <div key={stat.id} className="bg-white p-5 rounded-3xl shadow-sm text-center border border-slate-100 relative group hover:border-orange-200 transition"><button onClick={() => handleDeleteStat(stat.id)} className="absolute top-2 right-2 p-1.5 rounded-full bg-red-50 text-red-400 opacity-0 group-hover:opacity-100 transition hover:bg-red-100"><Icon name="x" size={12} /></button><div className="text-4xl font-bold text-orange-600 mb-2">{getServiceCount(stat.linkedServiceName)}</div><div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-tight">{stat.title}</div></div> ))}</div>
                            </div>
                        )}

                        {view === 'services' && (
                            <div className="space-y-6">
                                <button onClick={() => setShowRoleConfig(!showRoleConfig)} className="w-full bg-indigo-100 text-indigo-700 py-3 rounded-2xl font-bold text-sm shadow-sm flex items-center justify-center gap-2 hover:bg-indigo-200 transition"><Icon name="dollar-sign" size={18} /> üí≤ Costos Jerarqu√≠as</button>
                                {showRoleConfig && (
                                    <div className="bg-white p-5 rounded-3xl shadow-md border border-indigo-100 animate-[slide_0.3s_ease-out]">
                                        <h3 className="text-xs font-bold text-indigo-500 uppercase mb-4">Configurar precio para adquirir Jerarqu√≠a</h3>
                                        <div className="space-y-3">
                                            <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold text-slate-500">Cliente VIP:</span><input type="number" className="flex-1 border p-2 rounded-lg text-sm" placeholder="Precio" value={roleCosts.vip} onChange={e=>setRoleCosts({...roleCosts, vip: e.target.value})}/></div>
                                            <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold text-slate-500">Revendedor:</span><input type="number" className="flex-1 border p-2 rounded-lg text-sm" placeholder="Precio" value={roleCosts.reseller} onChange={e=>setRoleCosts({...roleCosts, reseller: e.target.value})}/></div>
                                            <div className="flex items-center gap-3"><span className="w-24 text-xs font-bold text-slate-500">L√≠der:</span><input type="number" className="flex-1 border p-2 rounded-lg text-sm" placeholder="Precio" value={roleCosts.leader} onChange={e=>setRoleCosts({...roleCosts, leader: e.target.value})}/></div>
                                            <button onClick={handleSaveRoleCosts} className="w-full bg-indigo-600 text-white py-2 rounded-xl font-bold text-sm mt-2 hover:bg-indigo-700">Guardar Precios</button>
                                        </div>
                                    </div>
                                )}

                                {!showServiceForm && !editingId && ( <button onClick={() => setShowServiceForm(true)} className="w-full bg-slate-900 text-white py-4 rounded-3xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-slate-200 hover:scale-[1.02] transition-transform"><Icon name="plus-circle" size={20} /> Nuevo Servicio</button> )}
                                {(showServiceForm || editingId) && ( 
                                    <div id="service-form-container" className="bg-white p-5 rounded-3xl shadow-md border border-slate-100 transition-all animate-[slide_0.3s_ease-out]">
                                        <h3 className="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2"><div className={`p-1 rounded-lg ${editingId ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}`}><Icon name={editingId ? "edit-3" : "plus-circle"} size={18} /></div>{editingId ? "Editar Servicio" : "Nuevo Servicio"}</h3>
                                        <form onSubmit={handleSaveService} className="space-y-4">
                                            <div className="space-y-2">
                                                <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="Nombre" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} />
                                                <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="Descripci√≥n" value={formData.description} onChange={e=>setFormData({...formData, description: e.target.value})} />
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mt-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2 block">Categor√≠a</label><div className="relative"><select className="w-full bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none focus:border-orange-300" value={formData.category} onChange={e=>setFormData({...formData, category: e.target.value})}><option value="clones">Clones (Documentos Editables)</option><option value="authentics">Aut√©nticos (Servicios Reales)</option></select><div className="absolute right-3 top-3 pointer-events-none text-slate-400"><Icon name="chevron-right" size={14} className="rotate-90"/></div></div></div>
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mt-2"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2 block">Precios por Jerarqu√≠a</label><div className="grid grid-cols-2 gap-2"><div className="relative"><span className="absolute left-2 top-2 text-slate-400 text-xs">$</span><input type="number" className="w-full pl-5 p-2 rounded-lg border border-slate-200 text-xs" placeholder="Cliente" value={formData.priceClient} onChange={e=>setFormData({...formData, priceClient: e.target.value})} /></div><div className="relative"><span className="absolute left-2 top-2 text-slate-400 text-xs">$</span><input type="number" className="w-full pl-5 p-2 rounded-lg border border-slate-200 text-xs" placeholder="VIP" value={formData.priceVip} onChange={e=>setFormData({...formData, priceVip: e.target.value})} /></div><div className="relative"><span className="absolute left-2 top-2 text-slate-400 text-xs">$</span><input type="number" className="w-full pl-5 p-2 rounded-lg border border-slate-200 text-xs" placeholder="Revendedor" value={formData.priceReseller} onChange={e=>setFormData({...formData, priceReseller: e.target.value})} /></div><div className="relative"><span className="absolute left-2 top-2 text-slate-400 text-xs">$</span><input type="number" className="w-full pl-5 p-2 rounded-lg border border-slate-200 text-xs" placeholder="L√≠der" value={formData.priceLeader} onChange={e=>setFormData({...formData, priceLeader: e.target.value})} /></div></div></div>
                                                <div className="flex gap-2 mt-2"><div className="relative flex-1"><span className="absolute left-3 top-3 text-slate-400 text-xs font-bold">#</span><input type="number" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 pl-7 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="Posici√≥n" value={formData.order} onChange={e=>setFormData({...formData, order: e.target.value})} /></div><input className="flex-[2] bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:ring-2 focus:ring-orange-200 outline-none transition" placeholder="Tiempo entrega" value={formData.deliveryTime} onChange={e=>setFormData({...formData, deliveryTime: e.target.value})} /></div>
                                            </div>
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2 block">Color</label><div className="flex flex-wrap gap-2">{COLOR_OPTIONS.map(c => (<button key={c.id} type="button" onClick={() => setFormData({...formData, colorId: c.id})} className={`w-8 h-8 rounded-full ${c.bg} ${c.text} flex items-center justify-center transition-all ${formData.colorId === c.id ? `ring-2 ${c.ring} scale-110 shadow-sm` : 'opacity-70 hover:opacity-100'}`} title={c.label}>{formData.colorId === c.id && <Icon name="chevron-right" size={14} className="rotate-90" />}</button>))}</div></div>
                                            <div><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2 block">Icono</label><div className="grid grid-cols-6 gap-2 max-h-32 overflow-y-auto p-1">{AVAILABLE_ICONS.map(iconKey => (<button key={iconKey} type="button" onClick={() => setFormData({...formData, icon: iconKey})} className={`p-2 rounded-xl flex items-center justify-center transition-all ${formData.icon === iconKey ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`} title={iconKey}><Icon name={iconKey} size={18} /></button>))}</div></div>
                                            <div className="flex gap-2 pt-2"><button type="button" onClick={resetForm} className="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs hover:bg-slate-200 transition">Cancelar</button><button type="submit" className={`flex-1 text-white py-3 rounded-xl font-bold text-sm shadow-md transition hover:opacity-90 ${editingId ? 'bg-blue-600' : 'bg-slate-900'}`}>{editingId ? "Guardar Cambios" : "Agregar Servicio"}</button></div>
                                        </form>
                                    </div> 
                                )}
                                
                                <div className="space-y-6">
                                    <ServiceList title="Clones (Documentos Editables)" colorClass="text-blue-500" iconName="edit-3" items={services.filter(s => (s.category || 'clones') === 'clones')} />
                                    <ServiceList title="Aut√©nticos (Servicios Reales)" colorClass="text-orange-500" iconName="shield" items={services.filter(s => s.category === 'authentics')} />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


                                                                                                                const WelcomeScreen = ({ onNavigate, onLogout, user }) => {
            const [balance, setBalance] = useState(0);
            const [membership, setMembership] = useState('Cliente');
            const [showRechargeModal, setShowRechargeModal] = useState(false); 
            const [showPaymentModal, setShowPaymentModal] = useState(false); 
            
            // NUEVO: Modal de Jerarqu√≠as
            const [showHierarchyModal, setShowHierarchyModal] = useState(false);
            const [roleCosts, setRoleCosts] = useState({ vip: 0, reseller: 0, leader: 0 });
            const [servicesList, setServicesList] = useState([]);

            const [currentTransaction, setCurrentTransaction] = useState({ amount: 0, ref: '' });
            const [isMenuOpen, setIsMenuOpen] = useState(false); 
            
            const isAdmin = user.email === "mrandroidtutorialeshd@gmail.com";

            useEffect(() => { 
                const unsub = db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if(doc.exists) { 
                        const data = doc.data();
                        setBalance(data.balance || 0); 
                        setMembership(data.membership || 'Cliente');
                    }
                });
                // Cargar precios de roles y servicios para la tabla comparativa
                db.collection('app_config').doc('role_prices').get().then(doc => { if(doc.exists) setRoleCosts(doc.data()); });
                db.collection('custom_services').get().then(snap => {
                    setServicesList(snap.docs.map(d => ({id:d.id, ...d.data()})));
                });

                return () => unsub();
            }, [user]);

            const handleInitiateRecharge = (amount) => {
                const val = parseFloat(amount);
                if(isNaN(val) || val < 200) { alert("Carga m√≠nima $200"); return; }
                const randomRef = 'RW' + Math.floor(Math.random() * 900 + 100);
                setCurrentTransaction({ amount: val, ref: randomRef });
                setShowRechargeModal(false); 
                setShowPaymentModal(true);   
            };

            const handleConfirmPayment = async () => {
                try {
                    await db.collection('recharge_requests').add({
                        userId: user.uid, email: user.email, amount: currentTransaction.amount,
                        reference: currentTransaction.ref, status: 'pending', 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("Solicitud enviada correctamente."); setShowPaymentModal(false);
                } catch (e) { alert("Error al solicitar recarga"); }
            };

            // L√ìGICA DE COMPRA DE JERARQU√çA
            const handlePurchaseRole = async (roleName, cost) => {
                if (balance < cost) return alert(`‚ö†Ô∏è Saldo insuficiente.\nNecesitas $${cost} para ser ${roleName}. Recarga tu cuenta.`);
                if (!confirm(`¬øConfirmar compra de membres√≠a ${roleName} por $${cost}?`)) return;

                try {
                    const batch = db.batch();
                    batch.update(db.collection('users').doc(user.uid), { 
                        balance: firebase.firestore.FieldValue.increment(-cost),
                        membership: roleName
                    });
                    // Guardar en historial de compras
                    const histRef = db.collection('purchased_services').doc();
                    batch.set(histRef, {
                        userId: user.uid,
                        serviceName: `Membres√≠a ${roleName}`,
                        cost: cost,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'paid'
                    });
                    await batch.commit();
                    alert(`‚úÖ ¬°Felicidades! Ahora eres ${roleName}. Tus precios se han actualizado.`);
                    setShowHierarchyModal(false);
                } catch (e) { alert("Error: " + e.message); }
            };

            // MODAL DE TABLA DE JERARQU√çAS
            const HierarchyModal = () => {
                if (!showHierarchyModal) return null;
                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center px-4">
                        <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onClick={() => setShowHierarchyModal(false)}></div>
                        <div className="bg-white w-full max-w-4xl h-[90vh] rounded-[30px] p-6 relative z-10 shadow-2xl animate-bounce-in flex flex-col overflow-hidden">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-extrabold text-slate-800 flex items-center gap-2"><Icon name="bar-chart" className="text-orange-600" /> Precios por Jerarqu√≠a</h2>
                                <button onClick={() => setShowHierarchyModal(false)} className="bg-slate-100 p-2 rounded-full text-slate-500 hover:bg-slate-200"><Icon name="x" size={20} /></button>
                            </div>
                            
                            <div className="overflow-auto flex-1 border border-slate-200 rounded-xl">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-700 font-bold sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th className="p-3 border-b">Servicio</th>
                                            <th className="p-3 border-b text-center min-w-[120px]">
                                                <div className="text-xs text-slate-400 uppercase">Gratis</div>
                                                <div>Cliente</div>
                                            </th>
                                            <th className="p-3 border-b text-center min-w-[120px] bg-indigo-50 text-indigo-700">
                                                <div className="text-xs uppercase opacity-70">Costo: ${roleCosts.vip || 0}</div>
                                                <div>VIP</div>
                                                {membership !== 'Cliente Vip' && membership !== 'Revendedor' && membership !== 'L√≠der' && (
                                                    <button onClick={()=>handlePurchaseRole('Cliente Vip', roleCosts.vip)} className="mt-1 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded w-full hover:bg-indigo-700">Adquirir</button>
                                                )}
                                            </th>
                                            <th className="p-3 border-b text-center min-w-[120px] bg-purple-50 text-purple-700">
                                                <div className="text-xs uppercase opacity-70">Costo: ${roleCosts.reseller || 0}</div>
                                                <div>Revendedor</div>
                                                {membership !== 'Revendedor' && membership !== 'L√≠der' && (
                                                    <button onClick={()=>handlePurchaseRole('Revendedor', roleCosts.reseller)} className="mt-1 bg-purple-600 text-white text-[10px] px-2 py-1 rounded w-full hover:bg-purple-700">Adquirir</button>
                                                )}
                                            </th>
                                            <th className="p-3 border-b text-center min-w-[120px] bg-yellow-50 text-yellow-700">
                                                <div className="text-xs uppercase opacity-70">Costo: ${roleCosts.leader || 0}</div>
                                                <div>L√≠der</div>
                                                {membership !== 'L√≠der' && (
                                                    <button onClick={()=>handlePurchaseRole('L√≠der', roleCosts.leader)} className="mt-1 bg-yellow-500 text-white text-[10px] px-2 py-1 rounded w-full hover:bg-yellow-600">Adquirir</button>
                                                )}
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {servicesList.map(s => (
                                            <tr key={s.id} className="hover:bg-slate-50">
                                                <td className="p-3 font-medium text-slate-700">{s.name}</td>
                                                <td className="p-3 text-center text-slate-500">${s.priceClient || s.price || 0}</td>
                                                <td className="p-3 text-center font-bold text-indigo-600 bg-indigo-50/30">${s.priceVip || s.price || 0}</td>
                                                <td className="p-3 text-center font-bold text-purple-600 bg-purple-50/30">${s.priceReseller || s.price || 0}</td>
                                                <td className="p-3 text-center font-bold text-yellow-600 bg-yellow-50/30">${s.priceLeader || s.price || 0}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-4 text-xs text-slate-400 text-center bg-slate-50 p-2 rounded-lg">
                                * Al adquirir una jerarqu√≠a, tus precios se actualizar√°n autom√°ticamente en la secci√≥n de Servicios.
                            </div>
                        </div>
                    </div>
                );
            };

            const RechargeModal = ({ isOpen, onClose, onSubmit }) => {
                const [amount, setAmount] = useState('');
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center px-4">
                        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onClick={onClose}></div>
                        <div className="bg-white w-full max-w-[340px] rounded-[35px] p-6 relative z-10 shadow-2xl animate-bounce-in">
                            <button onClick={onClose} className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full text-gray-400 hover:bg-gray-200 transition"><Icon name="arrow-left" size={16} /></button>
                            <div className="flex justify-center mb-4 mt-2"><div className="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(59,130,246,0.15)]"><Icon name="briefcase" className="text-blue-500" size={32} /></div></div>
                            <h2 className="text-xl font-extrabold text-center text-slate-800 mb-6 font-['Inter']">Cargar Saldo</h2>
                            <div className="bg-gray-100 rounded-2xl p-1 mb-5 shadow-inner border border-gray-100 relative"><div className="absolute left-0 top-0 h-full w-full flex items-center justify-center pointer-events-none opacity-20">{amount === '' && <span className="text-2xl font-bold">$0</span>}</div><input type="number" className="w-full bg-transparent text-center text-2xl font-bold text-slate-700 p-3 outline-none z-10 relative placeholder-transparent" placeholder="0" value={amount} onChange={(e) => setAmount(e.target.value)} autoFocus /></div>
                            <button onClick={() => onSubmit(amount)} className="w-full bg-[#007bff] text-white py-3.5 rounded-2xl font-bold text-sm shadow-[0_4px_14px_rgba(0,123,255,0.3)] hover:bg-blue-600 transition active:scale-95">Solicitar</button>
                            <div className="bg-[#fff9e6] border border-[#ffeeba] rounded-2xl p-4 mt-5"><div className="flex items-center gap-2 text-[#997404] font-bold text-[11px] mb-1.5 uppercase tracking-wide"><Icon name="shield" size={12} /> NOTA IMPORTANTE</div><p className="text-[#856404] text-[10px] leading-relaxed font-medium">La recarga m√≠nima es de <b className="text-[#6d5203]">$200 pesos</b> y el saldo no expira solo reduce en compras.</p></div>
                        </div>
                    </div>
                );
            };

            const PaymentModal = ({ isOpen, onClose, onConfirm, data }) => {
                const [timeLeft, setTimeLeft] = useState(600);
                useEffect(() => { if (!isOpen) return; const timer = setInterval(() => { setTimeLeft((prev) => (prev > 0 ? prev - 1 : 0)); }, 1000); return () => clearInterval(timer); }, [isOpen]);
                const formatTime = (seconds) => { const m = Math.floor(seconds / 60); const s = seconds % 60; return `${m}:${s < 10 ? '0' : ''}${s}`; };
                const copyToClipboard = (text) => { navigator.clipboard.writeText(text).then(() => { alert(`Copiado: ${text}`); }).catch(err => { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); document.execCommand("copy"); document.body.removeChild(textArea); alert(`Copiado: ${text}`); }); };
                if (!isOpen) return null;
                const CLABE = "646180402324335362"; const BENEFICIARIO = "AXLL";
                return (
                    <div className="fixed inset-0 z-[9999] flex items-center justify-center px-4">
                        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity"></div>
                        <div className="bg-white w-full max-w-[360px] rounded-[30px] p-5 relative z-10 shadow-2xl animate-bounce-in">
                            <div className="flex justify-between items-center mb-5"><h2 className="text-xl font-bold text-slate-900 flex items-center gap-2">Completar Pago</h2><div className="flex items-center gap-2"><div className="bg-red-50 text-red-500 font-mono font-bold text-lg px-3 py-1 rounded-lg border border-red-100 shadow-sm">{formatTime(timeLeft)}</div><button onClick={onClose} className="bg-gray-100 p-1.5 rounded-full text-gray-400 hover:bg-gray-200"><Icon name="x" size={18} /></button></div></div>
                            <div className="bg-[#f1f5f9] rounded-2xl p-4 border border-slate-200 mb-4 shadow-inner relative overflow-hidden">
                                <div className="absolute -right-6 -top-6 w-20 h-20 bg-blue-100 rounded-full opacity-50 blur-xl"></div>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Banco:</span><span className="font-bold text-slate-800">STP / Transferencia</span></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Cuenta CLABE:</span><div className="flex items-center gap-2"><span className="font-bold text-slate-800 tracking-tight text-[13px]">{CLABE}</span><button onClick={()=>copyToClipboard(CLABE)} className="text-slate-400 hover:text-blue-500 bg-white p-1 rounded-md shadow-sm border border-slate-100"><Icon name="copy" size={14} /></button></div></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Beneficiario:</span><div className="flex items-center gap-2"><span className="font-bold text-slate-800">{BENEFICIARIO}</span><button onClick={()=>copyToClipboard(BENEFICIARIO)} className="text-slate-400 hover:text-blue-500 bg-white p-1 rounded-md shadow-sm border border-slate-100"><Icon name="copy" size={14} /></button></div></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Monto exacto:</span><span className="font-extrabold text-green-600 text-base">${data.amount}</span></div>
                                    <div className="flex justify-between items-center pt-1"><span className="text-slate-500">Concepto/Ref:</span><div className="flex items-center gap-2"><span className="bg-slate-200 text-slate-700 px-2 py-0.5 rounded text-xs font-bold font-mono border border-slate-300">{data.ref}</span><button onClick={()=>copyToClipboard(data.ref)} className="text-slate-400 hover:text-blue-500 bg-white p-1 rounded-md shadow-sm border border-slate-100"><Icon name="copy" size={14} /></button></div></div>
                                </div>
                            </div>
                            <div className="space-y-3"><button onClick={onConfirm} className="w-full bg-[#0f172a] text-white py-3.5 rounded-xl font-bold text-sm shadow-lg shadow-slate-200 hover:bg-slate-800 transition transform active:scale-[0.98]">Ya realic√© el pago</button><button onClick={onClose} className="w-full bg-red-50 text-red-500 py-2.5 rounded-xl font-bold text-xs hover:bg-red-100 transition">Cancelar Solicitud</button></div>
                        </div>
                    </div>
                );
            };

            const SideMenu = () => (
                <div className="fixed inset-0 z-[9999] flex justify-end">
                    <div className="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onClick={() => setIsMenuOpen(false)}></div>
                    <div className="relative bg-white w-[280px] h-full shadow-2xl flex flex-col animate-[slide_0.3s_ease-out]">
                        <div className="bg-orange-600 p-6 pt-10 pb-6 text-white"><h2 className="text-xl font-bold">Men√∫</h2><p className="text-orange-100 text-xs mt-1 opacity-80">{user.email}</p><button onClick={() => setIsMenuOpen(false)} className="absolute top-4 right-4 p-2 bg-orange-700/50 rounded-full text-white hover:bg-orange-700"><Icon name="chevron-right" size={20} /></button></div>
                        <div className="flex-1 p-4 space-y-2 overflow-y-auto">
                            {isAdmin && <button onClick={() => { setIsMenuOpen(false); onNavigate('admin'); }} className="w-full flex items-center gap-4 p-4 rounded-2xl bg-orange-50 text-orange-700 font-bold text-sm hover:bg-orange-100 transition"><div className="bg-white p-2 rounded-full shadow-sm"><Icon name="shield" size={20} /></div>Panel Admin</button>}
                            <button onClick={() => { setIsMenuOpen(false); onNavigate('generated_pdfs'); }} className="w-full flex items-center gap-4 p-4 rounded-2xl bg-slate-50 text-slate-700 font-bold text-sm hover:bg-slate-100 transition"><div className="bg-white p-2 rounded-full shadow-sm"><Icon name="receipt" size={20} /></div>PDF Generados</button>
                        </div>
                        <div className="p-4 border-t border-gray-100"><button onClick={onLogout} className="w-full flex items-center gap-4 p-4 rounded-2xl bg-red-50 text-red-600 font-bold text-sm hover:bg-red-100 transition"><div className="bg-white p-2 rounded-full shadow-sm"><Icon name="log-out" size={20} /></div>Cerrar Sesi√≥n</button></div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-orange-50 font-sans pb-8">
                    <RechargeModal isOpen={showRechargeModal} onClose={() => setShowRechargeModal(false)} onSubmit={handleInitiateRecharge} />
                    <PaymentModal isOpen={showPaymentModal} onClose={() => setShowPaymentModal(false)} onConfirm={handleConfirmPayment} data={currentTransaction} />
                    <HierarchyModal />
                    {isMenuOpen && <SideMenu />}

                    <div className="bg-orange-600 px-6 pt-10 pb-12 text-white flex justify-between items-center rounded-b-[40px] shadow-md relative z-0">
                        <div><h1 className="text-2xl font-bold tracking-tight">Cocina Express</h1><p className="text-orange-100 opacity-90 text-sm font-medium">{isAdmin?"MODO ADMIN":`Hola, ${user.email.split('@')[0]}`}</p></div>
                        <button onClick={() => setIsMenuOpen(true)} className="p-3 bg-orange-700/50 rounded-full backdrop-blur-sm hover:bg-orange-700 transition"><Icon name="utensils" size={24} className="text-white"/></button>
                    </div>
                    
                    <div className="px-6 -mt-8 mb-6 relative z-10">
                        <div className="flex gap-3 items-stretch">
                            <div className="bg-[#1e293b] p-4 rounded-3xl flex-1 shadow-lg text-white"><p className="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Tu Saldo</p><h2 className="text-2xl font-bold text-[#4ade80]">${balance.toLocaleString()}</h2></div>
                            {/* TARJETA JERARQU√çA CLICKEABLE */}
                            <div onClick={() => setShowHierarchyModal(true)} className="bg-white p-4 rounded-3xl flex-1 shadow-lg border border-gray-100 cursor-pointer hover:bg-slate-50 transition active:scale-95 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="bar-chart" size={40}/></div>
                                <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">Jerarqu√≠a</p>
                                <h2 className="text-lg font-bold text-gray-900 truncate">{membership}</h2>
                                <p className="text-[9px] text-blue-500 font-bold mt-1">Ver precios ‚Üí</p>
                            </div>
                            <button onClick={() => setShowRechargeModal(true)} className="bg-orange-500 w-[64px] rounded-3xl shadow-lg shadow-orange-200 flex items-center justify-center hover:bg-orange-600 transition-colors active:scale-95"><Icon name="plus" size={32} className="text-white" /></button>
                        </div>
                    </div>

                    <div className="px-6 space-y-4">
                        <div onClick={()=>onNavigate('services')} className="bg-white p-5 rounded-3xl shadow-sm flex items-center gap-4 cursor-pointer border border-orange-100 active:scale-[0.98] transition-transform"><div className="bg-orange-100 p-3.5 rounded-2xl text-orange-600"><Icon name="utensils" size={24} /></div><div className="flex-1"><h3 className="text-lg font-bold text-gray-900">Servicios</h3><p className="text-gray-500 text-xs">Recetas, Actas y Notas</p></div><Icon name="chevron-right" className="text-gray-400" size={20} /></div>
                        <div onClick={()=>onNavigate('history')} className="bg-white p-5 rounded-3xl shadow-sm flex items-center gap-4 cursor-pointer border border-orange-100 active:scale-[0.98] transition-transform"><div className="bg-red-100 p-3.5 rounded-2xl text-red-600"><Icon name="history" size={24} /></div><div className="flex-1"><h3 className="text-lg font-bold text-gray-900">Historial</h3><p className="text-gray-500 text-xs">Consultar movimientos</p></div><Icon name="chevron-right" className="text-gray-400" size={20} /></div>
                        <div onClick={()=>window.open("https://streamevolution.pages.dev/StreamEvolution", "_blank")} className="bg-white p-5 rounded-3xl shadow-sm flex items-center gap-4 cursor-pointer border border-orange-100 active:scale-[0.98] transition-transform"><div className="bg-purple-100 p-3.5 rounded-2xl text-purple-600"><Icon name="tv" size={24} /></div><div className="flex-1"><h3 className="text-lg font-bold text-gray-900">Streaming</h3><p className="text-gray-500 text-xs">Plataformas digitales</p></div><Icon name="chevron-right" className="text-gray-400" size={20} /></div>
                    </div>
                </div>
            );
        };

                                                                                                                                const ServicesMenu = ({ onNavigate, user }) => {
            const [customServices, setCustomServices] = useState([]);
            const [selectedService, setSelectedService] = useState(null); 
            const [userProfile, setUserProfile] = useState(null);
            
            const [formValues, setFormValues] = useState({});
            const [view, setView] = useState('clones');

            useEffect(() => {
                if(user) {
                    const unsub = db.collection('users').doc(user.uid).onSnapshot(doc => {
                        setUserProfile(doc.data());
                    });
                    return () => unsub();
                }
            }, [user]);

            useEffect(() => {
                const unsub = db.collection('custom_services').onSnapshot(snap => {
                    let docs = snap.docs.map(doc => ({id: doc.id, isActive: true, category: 'clones', ...doc.data()})); 
                    docs = docs.filter(s => s.isActive !== false);
                    docs.sort((a, b) => (a.order || 999) - (b.order || 999));
                    setCustomServices(docs);
                });
                return () => unsub();
            }, []);

            const getServiceFields = (serviceName) => {
                const name = serviceName.toUpperCase();
                if (name.includes("ANTECEDENTES NO PENALES")) {
                    return [
                        { key: 'curp', label: 'CURP', placeholder: 'CURP' },
                        { key: 'nombres', label: 'Nombres', placeholder: 'Nombres' },
                        { key: 'paterno', label: 'Apellido Paterno', placeholder: 'Apellido Paterno' },
                        { key: 'materno', label: 'Apellido Materno', placeholder: 'Apellido Materno' },
                        { key: 'fechaNac', label: 'Fecha Nac.', placeholder: 'DD/MM/AAAA' },
                        { key: 'domicilio', label: 'Domicilio', placeholder: 'Domicilio Completo' },
                        { key: 'claveElector', label: 'Clave Elector', placeholder: 'Clave de Elector' }
                    ];
                }
                if (name.includes("CERTIFICADO COVID")) {
                    return [
                        { key: 'curp', label: 'CURP', placeholder: 'CURP' },
                        { key: 'nombre', label: 'Nombre Completo', placeholder: 'Nombre Completo' }
                    ];
                }
                const singleCurpServices = [
                    "NACIMIENTO", "DIVORCIO", "DEFUNCI√ìN", "DEFUNCION", "MATRIMONIO",
                    "CURP ACTUALIZADA", "LOCALIZA NSS", "AFOR√â", "AFORE", "SEMANAS COTIZADAS"
                ];
                if (singleCurpServices.some(k => name.includes(k))) {
                    return [{ key: 'curp', label: 'Datos del Documento', placeholder: 'Escriba CURP' }];
                }
                return null;
            };

            const getPrice = (service) => {
                const role = userProfile?.membership || 'Cliente';
                if (role === 'L√≠der' && service.priceLeader) return service.priceLeader;
                if (role === 'Revendedor' && service.priceReseller) return service.priceReseller;
                if (role === 'Cliente Vip' && service.priceVip) return service.priceVip;
                return service.priceClient || service.price || '0';
            };

            const handleInputChange = (key, value) => {
                setFormValues(prev => ({ ...prev, [key]: value.toUpperCase() }));
            };

            const handleCloseModal = () => { setSelectedService(null); setFormValues({}); };

            const activeFields = selectedService && selectedService.category === 'authentics' ? getServiceFields(selectedService.name) : null;

            const handlePlaceOrder = async () => {
                if (!selectedService || !userProfile) return;

                if (activeFields) {
                    for (let field of activeFields) {
                        if (!formValues[field.key] || !formValues[field.key].trim()) {
                            alert(`‚ö†Ô∏è Falta completar: ${field.label}`);
                            return;
                        }
                    }
                }

                const price = parseFloat(getPrice(selectedService));
                const currentBalance = parseFloat(userProfile.balance || 0);

                if (currentBalance < price) {
                    alert(`‚ö†Ô∏è Saldo insuficiente.\n\nCosto: $${price}\nTu saldo: $${currentBalance}\n\nPor favor recarga tu cuenta.`);
                    return;
                }

                if (!confirm(`¬øConfirmar pago de $${price} por ${selectedService.name}?`)) return;

                try {
                    const batch = db.batch();
                    const userRef = db.collection('users').doc(user.uid);
                    
                    batch.update(userRef, { balance: firebase.firestore.FieldValue.increment(-price) });

                    if (activeFields) {
                        let dataString = "";
                        activeFields.forEach(f => { dataString += `${f.label}: ${formValues[f.key]} | `; });
                        dataString = dataString.slice(0, -3);

                        // 1. Preparamos referencias para vincularlas
                        const historyRef = db.collection('purchased_services').doc();
                        const requestRef = db.collection('service_requests').doc();

                        // 2. Guardar Solicitud con ID del historial (VINCULACI√ìN)
                        batch.set(requestRef, {
                            userId: user.uid,
                            userEmail: user.email,
                            serviceName: selectedService.name,
                            cost: price,
                            targetCurp: dataString, 
                            historyId: historyRef.id, // <--- AQU√ç GUARDAMOS EL ID DEL HISTORIAL
                            status: 'pending',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // 3. Guardar Historial (Estado inicial: En Proceso)
                        batch.set(historyRef, {
                            userId: user.uid,
                            serviceName: selectedService.name + " (En Proceso)",
                            cost: price,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'paid'
                        });

                        await batch.commit();
                        alert(`‚úÖ Solicitud Enviada.\n\nServicio: ${selectedService.name}\nDatos recibidos.\n\nEl documento se procesar√° en breve.`);
                        handleCloseModal();

                    } else {
                        const historyRef = db.collection('purchased_services').doc();
                        batch.set(historyRef, {
                            userId: user.uid,
                            serviceName: selectedService.name,
                            cost: price,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'paid'
                        });

                        await batch.commit();

                        if (selectedService.name === 'Recetas IMSS') onNavigate('editor');
                        else if (selectedService.name === 'Notas de Remisi√≥n') onNavigate('note_editor');
                        else if (selectedService.name === 'Actas de Nacimiento') onNavigate('acta_editor');
                        else if (selectedService.name === 'Curp') onNavigate('curp_editor');
                        else if (selectedService.name === 'Incapacidad IMSS') onNavigate('incapacity_editor');
                        else if (selectedService.name === 'Comprobante CFE') onNavigate('cfe_editor');
                        else if (selectedService.name === 'Certificado Secundaria') onNavigate('secundaria_editor');
                        else if (selectedService.name === 'INE') onNavigate('ine_editor');
                        else { alert("‚úÖ Compra exitosa. Servicio activado."); handleCloseModal(); }
                    }

                } catch (e) {
                    console.error("Error:", e);
                    alert("‚ùå Error al procesar la compra.");
                }
            };

            const getColorTheme = (colorId) => COLOR_OPTIONS.find(c => c.id === colorId) || COLOR_OPTIONS[0];
            const filteredServices = customServices.filter(s => (s.category || 'clones') === view);

            return (
                <div className="min-h-screen bg-orange-50 font-sans pb-8">
                    {selectedService && (
                        <div className="fixed inset-0 z-[100] bg-white flex flex-col animate-[slide_0.3s_ease-out]">
                            <button onClick={handleCloseModal} className="absolute top-6 left-6 p-3 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 transition z-10"><Icon name="arrow-left" size={24} /></button>
                            <div className="flex-1 flex flex-col items-center justify-start pt-20 px-8 text-center space-y-6 overflow-y-auto pb-32">
                                <div className={`w-28 h-28 rounded-[30px] flex items-center justify-center ${getColorTheme(selectedService.colorId).bg} ${getColorTheme(selectedService.colorId).text} shadow-2xl mb-2 transform scale-100`}><Icon name={selectedService.icon || 'briefcase'} size={56} /></div>
                                <div><h2 className="text-2xl font-black text-slate-900 mb-2 leading-tight tracking-tight">{selectedService.name}</h2><p className="text-sm text-slate-500 font-medium px-4 leading-relaxed">{selectedService.description}</p></div>
                                <div className="flex gap-4 w-full max-w-sm justify-center">
                                    <div className="flex-1 bg-red-50 p-3 rounded-2xl flex flex-col items-center border border-red-100"><span className="text-[9px] text-red-400 font-bold uppercase tracking-widest mb-1">PRECIO</span><span className="text-2xl font-black text-red-500">${getPrice(selectedService)}</span></div>
                                    {selectedService.deliveryTime && <div className="flex-1 bg-blue-50 p-3 rounded-2xl flex flex-col items-center border border-blue-100"><span className="text-[9px] text-blue-400 font-bold uppercase tracking-widest mb-1">ENTREGA</span><span className="text-2xl font-black text-blue-500">{selectedService.deliveryTime}</span></div>}
                                </div>
                                {activeFields && (
                                    <div className="w-full max-w-sm mt-4 animate-[slide_0.2s_ease-out] bg-slate-50 p-4 rounded-3xl border border-slate-200">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 text-left pl-1">Datos Requeridos</h3>
                                        <div className="space-y-3">
                                            {activeFields.map((field) => (
                                                <div key={field.key} className="text-left">
                                                    <label className="text-[10px] font-bold text-slate-500 uppercase ml-2 mb-1 block">{field.label}</label>
                                                    <input type="text" value={formValues[field.key] || ''} onChange={(e) => handleInputChange(field.key, e.target.value)} placeholder={field.placeholder} className="w-full bg-white border border-slate-200 p-3 rounded-xl text-sm font-bold text-slate-800 outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-100 transition-all placeholder:text-slate-300" />
                                                </div>
                                            ))}
                                        </div>
                                        <p className="text-[10px] text-orange-500 mt-4 font-bold text-center bg-orange-50 p-2 rounded-lg border border-orange-100">‚ö†Ô∏è Verifica que tus datos sean correctos.</p>
                                    </div>
                                )}
                            </div>
                            <div className="fixed bottom-0 left-0 w-full p-6 pb-8 bg-white/90 backdrop-blur-md border-t border-slate-100 z-20">
                                <button onClick={handlePlaceOrder} className="w-full bg-[#ffb3b3] text-[#7f1d1d] py-4 rounded-[25px] font-bold text-lg shadow-xl shadow-red-100 flex items-center justify-center gap-3 hover:bg-[#ff9999] transition transform active:scale-[0.98]">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>{activeFields ? "Solicitar Tr√°mite" : "Realizar Orden"}
                                </button>
                            </div>
                        </div>
                    )}
                    <div className="bg-orange-600 p-6 pt-12 pb-20 text-white rounded-b-[40px] shadow-lg relative z-0">
                        <button onClick={()=>onNavigate('welcome')} className="absolute top-6 left-6 p-2 bg-orange-700/50 rounded-full hover:bg-orange-800 transition"><Icon name="arrow-left" className="text-white" size={20} /></button>
                        <div className="mt-4"><h1 className="text-3xl font-bold">Servicios</h1><p className="text-orange-100 opacity-90 text-sm">Seleccione documento</p></div>
                    </div>
                    <div className="px-6 -mt-10 relative z-10 mb-6">
                        <div className="bg-white p-1.5 rounded-2xl shadow-lg flex border border-orange-100">
                            <button onClick={() => setView('authentics')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'authentics' ? 'bg-orange-50 text-orange-600 shadow-sm ring-1 ring-orange-200' : 'text-slate-400 hover:bg-slate-50'}`}>Aut√©nticos</button>
                            <button onClick={() => setView('clones')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'clones' ? 'bg-blue-50 text-blue-600 shadow-sm ring-1 ring-blue-200' : 'text-slate-400 hover:bg-slate-50'}`}>Clones</button>
                        </div>
                    </div>
                    <div className="px-6 space-y-4 relative z-0 pb-10">
                        {filteredServices.length === 0 && <div className="text-center py-10 opacity-50"><Icon name="box" size={48} className="mx-auto mb-2 text-gray-300" /><p className="text-gray-400 font-medium">No hay servicios en esta secci√≥n.</p></div>}
                        {filteredServices.map(service => {
                            const colorTheme = COLOR_OPTIONS.find(c => c.id === service.colorId) || COLOR_OPTIONS[0];
                            const currentPrice = getPrice(service);
                            return (
                                <div key={service.id} onClick={() => setSelectedService(service)} className="bg-white p-5 rounded-2xl shadow-sm flex items-center gap-4 border border-orange-100 transition-transform cursor-pointer hover:scale-[1.02] active:scale-[0.98]">
                                    <div className={`${colorTheme.bg} p-3 rounded-xl ${colorTheme.text} self-start`}><Icon name={service.icon || 'briefcase'} size={24} /></div>
                                    <div className="flex-1"><div className="flex justify-between items-start"><h3 className="text-lg font-bold leading-tight mb-1">{service.name}</h3><div className="text-gray-300"><Icon name="chevron-right" size={20} /></div></div><p className="text-xs text-gray-500 mb-2 line-clamp-1">{service.description}</p><div className="flex flex-wrap gap-2">{service.deliveryTime && <span className="bg-green-100 text-green-800 text-[10px] font-bold px-2 py-0.5 rounded border border-green-200 flex items-center gap-1"><Icon name="history" size={10} /> {service.deliveryTime}</span>}<span className="bg-red-100 text-red-800 text-[10px] font-bold px-2 py-0.5 rounded border border-red-200 flex items-center gap-1"><Icon name="dollar-sign" size={10} /> ${currentPrice}</span></div></div>
                                </div>
                            );
                        })}
                        <div className="h-4"></div>
                    </div>
                </div>
            );
        };
        

                                                const HistoryScreen = ({ onNavigate, user }) => {
            const [view, setView] = useState('recharges');
            const [recharges, setRecharges] = useState([]);
            const [services, setServices] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if (user) {
                    setLoading(true);
                    const unsub1 = db.collection('recharge_requests').where("userId", "==", user.uid).onSnapshot(snap => {
                        const data = snap.docs.map(doc => ({ id: doc.id, type: 'recharge', ...doc.data() }));
                        data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setRecharges(data);
                    });
                    const unsub2 = db.collection('purchased_services').where("userId", "==", user.uid).onSnapshot(snap => {
                        const data = snap.docs.map(doc => ({ id: doc.id, type: 'service', ...doc.data() }));
                        data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                        setServices(data);
                        setLoading(false);
                    });
                    return () => { unsub1(); unsub2(); };
                }
            }, [user]);

            const formatDate = (timestamp) => {
                if(!timestamp) return 'Reciente';
                return new Date(timestamp.seconds * 1000).toLocaleDateString("es-MX", { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            };

            const getStatusBadge = (status) => {
                switch(status) {
                    case 'approved': return <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold border border-green-200">Aprobado</span>;
                    case 'rejected': return <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold border border-red-200">Rechazado</span>;
                    default: return <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold border border-yellow-200">Pendiente</span>;
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-8">
                    <div className="bg-orange-600 p-6 pt-12 pb-20 text-white rounded-b-[40px] shadow-lg relative z-0">
                        <button onClick={()=>onNavigate('welcome')} className="absolute top-6 left-6 p-2 bg-orange-700/50 rounded-full hover:bg-orange-800 transition"><Icon name="arrow-left" className="text-white" size={20} /></button>
                        <div className="mt-4 text-center"><h1 className="text-3xl font-bold">Historial</h1><p className="text-orange-100 opacity-90 text-sm">Movimientos de tu cuenta</p></div>
                    </div>
                    <div className="px-6 -mt-10 relative z-10 mb-6">
                        <div className="bg-white p-1.5 rounded-2xl shadow-lg flex border border-orange-100">
                            <button onClick={() => setView('recharges')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'recharges' ? 'bg-orange-50 text-orange-600 shadow-sm ring-1 ring-orange-200' : 'text-slate-400 hover:bg-slate-50'}`}>Recargas</button>
                            <button onClick={() => setView('services')} className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all ${view === 'services' ? 'bg-blue-50 text-blue-600 shadow-sm ring-1 ring-blue-200' : 'text-slate-400 hover:bg-slate-50'}`}>Servicios</button>
                        </div>
                    </div>
                    <div className="px-6 space-y-3 relative z-0">
                        {view === 'recharges' && (
                            <>
                                {recharges.length === 0 && !loading && <div className="text-center py-12 opacity-50"><div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="dollar-sign" size={32} className="text-slate-400" /></div><p className="text-slate-400 text-sm font-medium">No hay recargas.</p></div>}
                                {recharges.map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center hover:shadow-md transition">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-3 rounded-xl ${item.status==='approved'?'bg-green-50 text-green-600':'bg-orange-50 text-orange-600'}`}><Icon name="dollar-sign" size={20} /></div>
                                            <div><h4 className="text-sm font-bold text-slate-800">Recarga</h4><p className="text-xs text-slate-400">{formatDate(item.timestamp)}</p></div>
                                        </div>
                                        <div className="text-right"><div className="text-sm font-extrabold text-green-600 mb-1">+${item.amount}</div>{getStatusBadge(item.status)}</div>
                                    </div>
                                ))}
                            </>
                        )}
                        {view === 'services' && (
                            <>
                                {services.length === 0 && !loading && <div className="text-center py-12 opacity-50"><div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3"><Icon name="briefcase" size={32} className="text-slate-400" /></div><p className="text-slate-400 text-sm font-medium">No hay servicios.</p></div>}
                                {services.map(item => (
                                    <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col gap-3 hover:shadow-md transition">
                                        <div className="flex justify-between items-center">
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                <div className="p-3 rounded-xl bg-blue-50 text-blue-600 flex-shrink-0"><Icon name="file-heart" size={20} /></div>
                                                <div className="min-w-0"><h4 className="text-sm font-bold text-slate-800 truncate">{item.serviceName}</h4><p className="text-xs text-slate-400">{formatDate(item.timestamp)}</p></div>
                                            </div>
                                            <div className="text-right flex-shrink-0 pl-2"><div className="text-sm font-extrabold text-slate-700 mb-1">-${item.cost}</div><span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">Pagado</span></div>
                                        </div>
                                        {/* BOT√ìN DE DESCARGA PARA EL USUARIO */}
                                        {item.downloadUrl && (
                                            <a href={item.downloadUrl} target="_blank" className="w-full bg-green-500 text-white py-2 rounded-xl text-center text-xs font-bold hover:bg-green-600 transition shadow-sm shadow-green-200 flex items-center justify-center gap-2">
                                                <Icon name="box" size={14} /> Descargar Documento
                                            </a>
                                        )}
                                    </div>
                                ))}
                            </>
                        )}
                        <div className="h-4"></div>
                    </div>
                </div>
            );
        };


                const RecipeEditor = ({ onNavigate, user }) => {
            const isAdmin = user.email === "mrandroidtutorialeshd@gmail.com";

            const [data, setData] = useState({
                paciente: { nss: '05209874840', agregado: '1M1999OR', nombre: 'RICARDO DE JESUS LOPEZ MONTOYA', curp: 'LOMR980622HMCPN01', sexo: 'MASCULINO', fechaNac: '22/06/1998', delegacion: 'TOLUCA', ump: '222', consultorio: '16', cve: '281401252110', turno: 'MATUTINO' },
                meta: { folio: '14041564087769', fecha: 'MARTES 16 DE DICIEMBRE DE 2025' },
                medico: { nombre: 'VALENTIN MOLINA DOMINGUEZ', tipo: 'M√âD. GENERAL', cedula: '12752209', matricula: '96150053', uni: 'Universidad Nacional Aut√≥noma de M√©xico (UNAM)' },
                medicamentos: [ { id: 1, text: '6389 CIPROFLOXACINO 500 MG ‚Äî CADA TABLETA CONTIENE: CIPROFLOXACINO 500 MG', ind: 'V√≠a de administraci√≥n Oral una Tableta (s) cada 12 Hora(s) durante 7 Dia(s) Cantidad a Surtir 1 ENV' }, { id: 2, text: '6338 FENIRAMINA 25 MG ‚Äî CADA TABLETA CONTIENE: FENIRAMINA 25 MG', ind: 'V√≠a de administraci√≥n Oral una Tableta (s) cada 8 Hora(s) durante 5 Dia(s) Cantidad a Surtir 1 ENV' }, { id: 3, text: '6482 GOTAS DE MANZANILLA ‚Äî SOLUCI√ìN OFT√ÅLMICA', ind: 'V√≠a de administraci√≥n Oft√°lmica, aplicar 2 gotas en cada ojo cada 8 horas durante 5 d√≠a(s). Cantidad a surtir 1 FRASCO.\nCHEQUEO DE PRESI√ìN ARTERIAL (T/A) Y GLUCOSA.\nSE INDICA TRATAMIENTO Y SE SOLICITAN ESTUDIOS DE CONTROL.' } ]
            });
            const handleChange = (s, f, v) => setData(p => ({...p, [s]: {...p[s], [f]: v.toUpperCase()}}));
            const handleMed = (id, f, v) => setData(p => ({...p, medicamentos: p.medicamentos.map(m => m.id===id ? {...m, [f]: v.toUpperCase()} : m)}));
            const addMed = () => setData(p => ({...p, medicamentos: [...p.medicamentos, {id: Date.now(), text: '', ind: ''}]}));
            const delMed = (id) => setData(p => ({...p, medicamentos: p.medicamentos.filter(m => m.id !== id)}));
                        const handleSave = async () => { 
                try { 
                    await db.collection('recetas_imss').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ Guardado"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); } 
            };
            const logoUrl = "https://i.postimg.cc/gJ8kqq0g/1766127957062.png";
            const qrContent = `Nombre: ${data.paciente.nombre}\nNSS: ${data.paciente.nss}\nFecha Nacimiento: ${data.paciente.fechaNac}\nCURP: ${data.paciente.curp}\nDelegaci√≥n: ${data.paciente.delegacion}\nCVE. PTAL: ${data.paciente.cve}\nFolio: ${data.meta.folio}`;
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrContent)}`;

            return (
                <div className={`flex flex-col ${isAdmin ? 'lg:flex-row' : ''} min-h-screen bg-white font-sans`}>
                    <div className={`w-full ${isAdmin ? 'lg:w-1/3' : 'max-w-3xl mx-auto shadow-xl rounded-b-3xl'} bg-gray-50 border-r p-4 no-print h-screen overflow-y-auto`}>
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-gray-50 z-10 py-2 border-b text-xs"><div className="flex items-center gap-2"><button onClick={()=>onNavigate('services')} className="p-2 hover:bg-gray-100 rounded-full text-gray-600 transition"><Icon name="arrow-left" size={20} /></button><h2 className="font-bold flex items-center gap-2 text-sm"><Icon name="edit-3" size={16} /> Editar</h2></div><div className="flex gap-2"><button onClick={handleSave} className="bg-orange-600 text-white px-3 py-1 rounded font-bold">GUARDAR</button>{isAdmin && <button onClick={()=>window.print()} className="bg-black text-white px-3 py-1 rounded font-bold">IMPRIMIR</button>}</div></div>
                        <div className="space-y-4 text-xs">
                             <fieldset className="border p-2 rounded bg-white"><legend className="font-bold text-gray-500">Paciente</legend><input className="w-full border mb-1 p-1" placeholder="Nombre" value={data.paciente.nombre} onChange={e=>handleChange('paciente','nombre',e.target.value)} /><div className="grid grid-cols-2 gap-1"><input className="border p-1" placeholder="NSS" value={data.paciente.nss} onChange={e=>handleChange('paciente','nss',e.target.value)} /><input className="border p-1" placeholder="Agregado" value={data.paciente.agregado} onChange={e=>handleChange('paciente','agregado',e.target.value)} /><input className="border p-1" placeholder="CURP" value={data.paciente.curp} onChange={e=>handleChange('paciente','curp',e.target.value)} /><input className="border p-1" placeholder="Fecha Nac" value={data.paciente.fechaNac} onChange={e=>handleChange('paciente','fechaNac',e.target.value)} /><input className="border p-1" placeholder="Delegaci√≥n" value={data.paciente.delegacion} onChange={e=>handleChange('paciente','delegacion',e.target.value)} /><input className="border p-1" placeholder="UMP" value={data.paciente.ump} onChange={e=>handleChange('paciente','ump',e.target.value)} /><input className="border p-1" placeholder="Consultorio" value={data.paciente.consultorio} onChange={e=>handleChange('paciente','consultorio',e.target.value)} /><input className="border p-1" placeholder="Turno" value={data.paciente.turno} onChange={e=>handleChange('paciente','turno',e.target.value)} /></div><input className="w-full border mt-1 p-1" placeholder="Cve Ptal" value={data.paciente.cve} onChange={e=>handleChange('paciente','cve',e.target.value)} /></fieldset>
                            <fieldset className="border p-2 rounded bg-white"><legend className="font-bold text-gray-500">Receta</legend><input className="w-full border mb-1 p-1" placeholder="Folio" value={data.meta.folio} onChange={e=>handleChange('meta','folio',e.target.value)} /><input className="w-full border mb-1 p-1" placeholder="Fecha Texto" value={data.meta.fecha} onChange={e=>handleChange('meta','fecha',e.target.value)} /><div className="mt-2 text-[10px] text-gray-500 italic bg-yellow-50 p-1 border border-yellow-200 rounded">Info QR: Se actualiza autom√°ticamente.</div></fieldset>
                            <fieldset className="border p-2 rounded bg-gray-50"><legend className="font-bold text-gray-500 flex justify-between w-full pb-1">Medicamentos <button onClick={addMed} className="bg-black text-white px-2 rounded">+</button></legend><div className="border-b border-gray-300 mx-4 mb-2"></div>{data.medicamentos.map(m => (<div key={m.id} className="mb-2 border-b border-gray-300 pb-2 bg-white p-1"><div className="flex justify-between"><span className="font-bold">Item</span> <button onClick={()=>delMed(m.id)} className="text-red-500 font-bold">x</button></div><input className="w-full border mb-1 p-1 font-bold" value={m.text} onChange={e=>handleMed(m.id,'text',e.target.value)} /><textarea className="w-full border p-1 h-12 resize-none" value={m.ind} onChange={e=>handleMed(m.id,'ind',e.target.value)}></textarea></div>))}</fieldset>
                             <fieldset className="border p-2 rounded bg-white"><legend className="font-bold text-gray-500">M√©dico</legend><input className="w-full border mb-1 p-1" value={data.medico.nombre} onChange={e=>handleChange('medico','nombre',e.target.value)} /><input className="w-full border mb-1 p-1 bg-blue-50 font-bold" value={data.medico.tipo} onChange={e=>handleChange('medico','tipo',e.target.value)} /><input className="w-full border mb-1 p-1" value={data.medico.uni} onChange={e=>handleChange('medico','uni',e.target.value)} /><div className="grid grid-cols-2 gap-1"><input className="border p-1" value={data.medico.cedula} onChange={e=>handleChange('medico','cedula',e.target.value)} /><input className="border p-1" value={data.medico.matricula} onChange={e=>handleChange('medico','matricula',e.target.value)} /></div></fieldset>
                        </div>
                    </div>
                    {/* VISTA PREVIA SOLO PARA ADMIN */}
                    {isAdmin && (
                        <div className="w-full lg:w-2/3 bg-white flex justify-center items-start p-4 print-area overflow-auto"><div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-8 relative text-black border border-gray-100"><div className="flex justify-between items-start"><div className="w-[55%] pr-2"><div className="flex flex-col items-center mb-1"><img src={logoUrl} className="h-10 w-auto mb-1 opacity-90" /><h1 className="text-[10px] font-bold tracking-wide text-center leading-none">INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1><p className="text-[5px] font-bold tracking-[0.2em] text-gray-500 mt-0.5 uppercase">Seguridad y Solidaridad Social</p></div><div className="w-full border-t border-b border-gray-400 py-0.5 my-2 text-center text-[7px] uppercase">Direcci√≥n de Prestaciones M√©dicas</div><div className="text-center mb-2"><h2 className="text-xl font-bold font-[Tinos] uppercase tracking-wide">Receta Individual</h2></div><div className="flex items-center justify-center gap-4 px-1"><div className="barcode"></div><div className="text-left leading-[1.1]"><div className="text-sm font-bold text-gray-900 mb-0.5 whitespace-nowrap">Folio: <span className="text-black text-sm font-black tracking-tight ml-1">{data.meta.folio}</span></div><div className="text-[10px] font-bold text-black uppercase max-w-[160px]">ESTA RECETA NO SE SURTIR√Å DESPU√âS DE LAS 72 HORAS DE SU EXPEDICI√ìN</div></div></div></div><div className="w-[45%] pl-2 pt-2 relative"><div className="double-box pt-box w-full"><div className="flex justify-between mb-0.5"><div><span className="pt-label">NS:</span><span className="pt-val">{data.paciente.nss}</span></div><div><span className="pt-label">AGREGADO. MED:</span><span className="pt-val">{data.paciente.agregado}</span></div></div><div className="text-center mb-0.5"><span className="pt-label block w-full mb-px">NOMBRE DEL PACIENTE:</span><div className="pt-val uppercase">{data.paciente.nombre}</div></div><div className="mb-0.5"><span className="pt-label">CURP:</span><span className="pt-val">{data.paciente.curp}</span></div><div className="flex gap-2 mb-0.5"><div><span className="pt-label">SEXO:</span><span className="pt-val">{data.paciente.sexo}</span></div><div><span className="pt-label">FECHA DE NACIMIENTO:</span><span className="pt-val">{data.paciente.fechaNac}</span></div></div><div className="mb-0.5"><span className="pt-label">DELEGACION:</span><span className="pt-val">{data.paciente.delegacion}</span></div><div className="flex justify-between mb-0.5"><div className="flex gap-2"><div><span className="pt-label">UMP:</span><span className="pt-val">{data.paciente.ump}</span></div><div><span className="pt-label">CONSULTORIO:</span><span className="pt-val">{data.paciente.consultorio}</span></div></div></div><div className="flex justify-between items-end"><div><span className="pt-label">CVE.PTAL</span><span className="pt-val">{data.paciente.cve}</span></div><div className="text-right"><span className="pt-label">TURNO:</span><span className="pt-val">{data.paciente.turno}</span></div></div></div><img src={qrCode} className="absolute -bottom-16 right-20 w-12 h-12" /></div></div><div className="double-box min-h-[500px] flex flex-col relative mt-2"><div className="flex justify-between items-center px-2 pt-1 text-[10px] font-bold uppercase"><div>FECHA: {data.meta.fecha}</div><div>Primer Nivel de Atenci√≥n</div></div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="p-2 flex-grow">{data.medicamentos.map(m => (<div key={m.id} className="med-item text-[10px] leading-snug"><div className="font-bold text-black px-1 mb-0.5">{m.text}</div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="pl-1 whitespace-pre-wrap">{m.ind}</div></div>))}</div><div className="border-t border-black mt-auto bg-white relative"><div className="pt-3 px-4 flex text-[9px] items-start relative z-20"><div className="w-[55%] pr-2 relative"><div className="flex flex-col items-start relative"><span className="font-bold mb-0.5 leading-none">Nombre y firma del m√©dico: {data.medico.nombre}</span><span className="font-bold uppercase leading-tight text-[8px] w-full">{data.medico.uni}</span></div></div><div className="w-[45%] flex justify-between items-start pl-4"><div className="flex flex-col items-start"><span className="font-bold mb-1 leading-none">C√©dula Profesional:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.cedula}</span></div><div className="flex flex-col items-end"><span className="font-bold mb-1 leading-none">Matr√≠cula:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.matricula}</span></div></div></div><div className="doctor-stamp absolute top-[0px] left-[40px] z-30 pointer-events-none"><img src={logoUrl} className="stamp-logo" /><div className="text-left text-[8px]"><div>DR(A). {data.medico.nombre}</div><div>{data.medico.tipo}</div><div>CED. PROF. {data.medico.cedula}</div><div>MATRICULA {data.medico.matricula}</div></div></div><div className="border-b border-black w-auto mx-4 mt-1 mb-1 relative z-10"></div><div className="h-20 w-full bg-white relative z-0 flex flex-col items-end justify-start px-4"><span className="font-bold text-[9px] uppercase mt-1">PACIENTE</span></div></div></div></div></div>
                    )}
                </div>
            );
        };
        
                // ==========================================
        // NUEVO COMPONENTE: EDITOR NOTAS DE REMISI√ìN
        // ==========================================
                const NoteEditor = ({ onNavigate, user }) => {
            const isAdmin = user.email === "mrandroidtutorialeshd@gmail.com";
            const [data, setData] = useState({
                folio: Math.floor(Math.random() * 100000),
                fecha: new Date().toLocaleDateString('es-MX'),
                cliente: { nombre: '', direccion: '', telefono: '', ciudad: '' },
                items: [{ id: 1, cant: 1, desc: 'Producto General', precio: 0 }]
            });

            // Helpers para actualizar estado
            const updateClient = (k, v) => setData(prev => ({ ...prev, cliente: { ...prev.cliente, [k]: v.toUpperCase() } }));
            const updateItem = (id, field, val) => {
                setData(prev => ({
                    ...prev,
                    items: prev.items.map(i => i.id === id ? { ...i, [field]: field === 'desc' ? val.toUpperCase() : parseFloat(val) || 0 } : i)
                }));
            };
            const addItem = () => setData(prev => ({ ...prev, items: [...prev.items, { id: Date.now(), cant: 1, desc: '', precio: 0 }] }));
            const delItem = (id) => setData(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
            
            // Calcular Total
            const getTotal = () => data.items.reduce((acc, item) => acc + (item.cant * item.precio), 0);

            // Guardar en Firebase
                        const handleSave = async () => {
                try {
                    await db.collection('notas_remision').add({
                        ...data,
                        total: getTotal(),
                        userId: user.uid,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("‚úÖ Nota guardada en historial");
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error al guardar"); }
            };

            return (
                <div className={`flex flex-col ${isAdmin ? 'lg:flex-row' : ''} min-h-screen bg-slate-100 font-sans`}>
                    {/* PANEL IZQUIERDO: EDICI√ìN */}
                    <div className={`w-full ${isAdmin ? 'lg:w-1/3' : 'max-w-2xl mx-auto shadow-xl rounded-b-3xl'} bg-white border-r border-slate-200 p-4 h-screen overflow-y-auto no-print z-50`}>
                        <div className="sticky top-0 bg-white z-10 pb-4 border-b border-slate-100 mb-4">
                            <div className="flex justify-between items-center mb-4">
                                <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition"><Icon name="arrow-left" size={20}/></button>
                                <h2 className="font-bold text-slate-800">Nota Remisi√≥n</h2>
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-blue-700">Guardar</button>
                                    {isAdmin && <button onClick={() => window.print()} className="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm hover:bg-slate-900">Imprimir</button>}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <input className="border p-2 rounded-lg text-xs bg-slate-50" placeholder="Folio" value={data.folio} onChange={e => setData({...data, folio: e.target.value})} />
                                <input className="border p-2 rounded-lg text-xs bg-slate-50" placeholder="Fecha" value={data.fecha} onChange={e => setData({...data, fecha: e.target.value})} />
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <p className="text-[10px] font-bold text-slate-400 uppercase mb-2">Cliente</p>
                                <input className="w-full border p-2 rounded-lg text-xs mb-2 bg-white" placeholder="Nombre completo" value={data.cliente.nombre} onChange={e => updateClient('nombre', e.target.value)} />
                                <input className="w-full border p-2 rounded-lg text-xs mb-2 bg-white" placeholder="Direcci√≥n" value={data.cliente.direccion} onChange={e => updateClient('direccion', e.target.value)} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input className="w-full border p-2 rounded-lg text-xs bg-white" placeholder="Ciudad" value={data.cliente.ciudad} onChange={e => updateClient('ciudad', e.target.value)} />
                                    <input className="w-full border p-2 rounded-lg text-xs bg-white" placeholder="Tel√©fono" value={data.cliente.telefono} onChange={e => updateClient('telefono', e.target.value)} />
                                </div>
                            </div>

                            <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <div className="flex justify-between items-center mb-2">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase">Productos</p>
                                    <button onClick={addItem} className="text-[10px] bg-green-500 text-white px-2 py-1 rounded font-bold hover:bg-green-600">+ Agregar</button>
                                </div>
                                {data.items.map((item, idx) => (
                                    <div key={item.id} className="bg-white p-2 rounded-lg border border-slate-100 mb-2 shadow-sm relative group">
                                        <button onClick={() => delItem(item.id)} className="absolute top-1 right-1 text-red-300 hover:text-red-500"><Icon name="x" size={14}/></button>
                                        <div className="flex gap-2 mb-2 pr-6">
                                            <div className="w-12"><span className="text-[9px] text-slate-400 block">Cant</span><input type="number" className="w-full border-b border-slate-200 text-sm font-bold text-center outline-none focus:border-blue-500" value={item.cant} onChange={e => updateItem(item.id, 'cant', e.target.value)} /></div>
                                            <div className="flex-1"><span className="text-[9px] text-slate-400 block">Descripci√≥n</span><input className="w-full border-b border-slate-200 text-sm font-medium outline-none focus:border-blue-500" value={item.desc} onChange={e => updateItem(item.id, 'desc', e.target.value)} /></div>
                                        </div>
                                        <div className="flex justify-between items-center bg-slate-50 p-1.5 rounded">
                                            <div className="flex items-center gap-2">
                                                <span className="text-[9px] text-slate-400">Precio Unit: $</span>
                                                <input type="number" className="w-16 bg-transparent border-b border-slate-300 text-xs font-bold outline-none" value={item.precio} onChange={e => updateItem(item.id, 'precio', e.target.value)} />
                                            </div>
                                            <div className="text-xs font-bold text-slate-700">Total: ${(item.cant * item.precio).toFixed(2)}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* PANEL DERECHO: VISTA PREVIA IMPRESI√ìN (SOLO ADMIN) */}
                    {isAdmin && (
                        <div className="w-full lg:w-2/3 bg-slate-200 flex justify-center items-start p-8 print-area overflow-auto">
                            <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-12 relative text-black shadow-2xl">
                                {/* ENCABEZADO */}
                                <div className="flex justify-between items-end border-b-4 border-slate-800 pb-4 mb-8">
                                    <div>
                                        <h1 className="text-4xl font-extrabold text-slate-900 tracking-tighter">NOTA DE REMISI√ìN</h1>
                                        <p className="text-sm font-medium text-slate-500 mt-1">COMPROBANTE DE VENTA</p>
                                    </div>
                                    <div className="text-right">
                                        <div className="inline-block bg-red-50 border border-red-100 px-3 py-1 rounded mb-1">
                                            <span className="text-red-500 font-bold text-xs uppercase mr-2">Folio</span>
                                            <span className="text-red-600 font-black text-xl font-mono">N¬∞ {data.folio}</span>
                                        </div>
                                        <div className="text-sm font-bold text-slate-800">{data.fecha}</div>
                                    </div>
                                </div>

                                {/* DATOS CLIENTE */}
                                <div className="flex gap-8 mb-8 text-sm">
                                    <div className="flex-1 space-y-3">
                                        <div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-24 text-slate-500 uppercase text-[10px] pt-1">Cliente:</span> <span className="font-bold text-slate-800 uppercase flex-1">{data.cliente.nombre}</span></div>
                                        <div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-24 text-slate-500 uppercase text-[10px] pt-1">Direcci√≥n:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.direccion}</span></div>
                                    </div>
                                    <div className="w-1/3 space-y-3">
                                        <div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-20 text-slate-500 uppercase text-[10px] pt-1">Ciudad:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.ciudad}</span></div>
                                        <div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-20 text-slate-500 uppercase text-[10px] pt-1">Tel√©fono:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.telefono}</span></div>
                                    </div>
                                </div>

                                {/* TABLA */}
                                <table className="w-full mb-8">
                                    <thead>
                                        <tr className="bg-slate-900 text-white text-[10px] uppercase tracking-wider">
                                            <th className="py-2 px-2 text-center w-16 rounded-l">Cant.</th>
                                            <th className="py-2 px-4 text-left">Descripci√≥n</th>
                                            <th className="py-2 px-2 text-right w-24">Precio</th>
                                            <th className="py-2 px-2 text-right w-24 rounded-r">Importe</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-xs">
                                        {data.items.map((item, i) => (
                                            <tr key={i} className="border-b border-slate-100">
                                                <td className="py-3 text-center font-bold text-slate-600">{item.cant}</td>
                                                <td className="py-3 px-4 font-medium text-slate-800 uppercase">{item.desc}</td>
                                                <td className="py-3 text-right text-slate-500">${item.precio.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                                <td className="py-3 text-right font-bold text-slate-900">${(item.cant * item.precio).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                                            </tr>
                                        ))}
                                        {/* Relleno visual para que no se vea vac√≠a la hoja */}
                                        {[...Array(Math.max(0, 8 - data.items.length))].map((_, i) => (
                                            <tr key={'empty'+i} className="h-8 border-b border-slate-50"><td></td><td></td><td></td><td></td></tr>
                                        ))}
                                    </tbody>
                                </table>

                                {/* TOTALES */}
                                <div className="flex justify-end">
                                    <div className="w-1/3 bg-slate-50 rounded-xl p-4 border border-slate-100">
                                        <div className="flex justify-between items-center text-slate-500 text-xs font-bold mb-2 uppercase">
                                            <span>Subtotal</span>
                                            <span>${getTotal().toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-slate-900 text-lg font-black border-t-2 border-slate-200 pt-2">
                                            <span>TOTAL</span>
                                            <span>${getTotal().toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* PIE DE P√ÅGINA */}
                                <div className="absolute bottom-10 left-0 w-full text-center">
                                    <p className="text-[9px] text-slate-400 font-bold tracking-widest uppercase mb-1">Gracias por su preferencia</p>
                                    <div className="w-16 h-1 bg-slate-100 mx-auto"></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
                // ==========================================
        // EDITOR ACTA DE NACIMIENTO (NUEVO)
        // ==========================================
        const BirthCertificateEditor = ({ onNavigate, user }) => {
            const [data, setData] = useState({
                curp: '', entidadRegistro: 'CIUDAD DE MEXICO', municipioRegistro: 'ALVARO OBREGON',
                fechaRegistro: new Date().toLocaleDateString('es-MX'), libro: Math.floor(Math.random() * 500),
                numeroActa: Math.floor(Math.random() * 10000),
                datosPersona: { nombre: '', primerApellido: '', segundoApellido: '', fechaNac: '', sexo: 'MUJER', lugarNac: 'CIUDAD DE MEXICO' },
                padres: { nombrePadre1: '', nacionalidad1: 'MEXICANA', nombrePadre2: '', nacionalidad2: 'MEXICANA' },
                identificador: Math.floor(Math.random() * 1000000000000000000).toString()
            });

            const updatePersona = (k, v) => setData(p => ({...p, datosPersona: {...p.datosPersona, [k]: v.toUpperCase()}}));
            const updatePadres = (k, v) => setData(p => ({...p, padres: {...p.padres, [k]: v.toUpperCase()}}));
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`CURP:${data.curp}|ACTA:${data.numeroActa}`)}`;

                        const handleSave = async () => {
                try { 
                    await db.collection('actas_nacimiento').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ Guardado"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); }
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    <div className="w-full lg:w-1/3 bg-white border-r p-4 h-screen overflow-y-auto no-print z-50 shadow-xl">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar Acta</h2>
                            <div className="flex gap-2"><button onClick={handleSave} className="bg-green-700 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button><button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Datos Registro</p><input className="w-full border p-2 text-xs mb-1" placeholder="CURP" value={data.curp} onChange={e=>setData({...data, curp:e.target.value.toUpperCase()})}/><input className="w-full border p-2 text-xs mb-1" placeholder="Entidad" value={data.entidadRegistro} onChange={e=>setData({...data, entidadRegistro:e.target.value.toUpperCase()})}/><input className="w-full border p-2 text-xs" placeholder="Municipio" value={data.municipioRegistro} onChange={e=>setData({...data, municipioRegistro:e.target.value.toUpperCase()})}/></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Persona</p><input className="w-full border p-2 text-xs mb-1" placeholder="Nombre" value={data.datosPersona.nombre} onChange={e=>updatePersona('nombre',e.target.value)}/><div className="flex gap-1"><input className="w-1/2 border p-2 text-xs" placeholder="1er Apellido" value={data.datosPersona.primerApellido} onChange={e=>updatePersona('primerApellido',e.target.value)}/><input className="w-1/2 border p-2 text-xs" placeholder="2do Apellido" value={data.datosPersona.segundoApellido} onChange={e=>updatePersona('segundoApellido',e.target.value)}/></div></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Padres</p><input className="w-full border p-2 text-xs mb-1" placeholder="Padre 1" value={data.padres.nombrePadre1} onChange={e=>updatePadres('nombrePadre1',e.target.value)}/><input className="w-full border p-2 text-xs" placeholder="Padre 2" value={data.padres.nombrePadre2} onChange={e=>updatePadres('nombrePadre2',e.target.value)}/></div>
                        </div>
                    </div>
                    <div className="w-full lg:w-2/3 bg-gray-200 flex justify-center p-6 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] p-10 relative text-black shadow-2xl border-[10px] border-[#6b2633] outline outline-4 outline-[#d4af37]">
                            <div className="flex justify-between items-start mb-6"><div className="w-1/3 text-[10px] uppercase font-bold text-gray-500">Estados Unidos Mexicanos</div><div className="w-1/3 text-center"><h1 className="text-xl font-serif font-bold text-[#6b2633] uppercase">Acta de Nacimiento</h1></div><div className="w-1/3 text-right text-[10px] font-mono">{data.identificador}</div></div>
                            <div className="bg-gray-100 rounded p-2 mb-6 flex justify-between items-center border"><span className="text-xs font-bold text-gray-500">CURP</span><span className="text-xl font-bold font-mono">{data.curp}</span></div>
                            <div className="mb-6"><div className="bg-[#6b2633] text-white text-[10px] font-bold uppercase px-2 py-1 mb-2">Datos de la Persona</div><div className="text-xs font-bold uppercase grid grid-cols-2 gap-4"><div><span className="text-[9px] text-gray-500 block">Nombre:</span>{data.datosPersona.nombre} {data.datosPersona.primerApellido} {data.datosPersona.segundoApellido}</div><div><span className="text-[9px] text-gray-500 block">Fecha Nac:</span>{data.datosPersona.fechaNac}</div></div></div>
                            <div className="flex gap-4 items-end mt-auto pt-8 border-t"><img src={qrCode} className="w-24 h-24"/><div className="text-[9px] text-right flex-1"><div>ENTIDAD: {data.entidadRegistro}</div><div>LIBRO: {data.libro}</div><div>ACTA: {data.numeroActa}</div></div></div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // EDITOR CURP (NUEVO)
        // ==========================================
        const CurpEditor = ({ onNavigate, user }) => {
            const [data, setData] = useState({
                curp: '', nombre: '', primerApellido: '', segundoApellido: '',
                sexo: 'HOMBRE', fechaNac: '', entidad: 'CIUDAD DE MEXICO',
                folio: Math.floor(Math.random() * 100000000),
                fechaInscripcion: new Date().toLocaleDateString('es-MX'),
                anioRegistro: '2025', numeroLibro: Math.floor(Math.random() * 500)
            });

            // Generador de c√≥digo de barras simple (visual) y QR
            const barcode = Array(40).fill(0).map(() => Math.random() > 0.5 ? '3px' : '1px');
            const qrContent = `CURP:${data.curp}|NOMBRE:${data.nombre}|FOLIO:${data.folio}`;
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrContent)}`;

                        const handleSave = async () => {
                try { 
                    await db.collection('curp_history').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ CURP Guardada"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); }
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* PANEL IZQUIERDO: FORMULARIO */}
                    <div className="w-full lg:w-1/3 bg-white border-r p-4 h-screen overflow-y-auto no-print z-50 shadow-xl">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar CURP</h2>
                            <div className="flex gap-2"><button onClick={handleSave} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button><button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Datos Principales</p><input className="w-full border p-2 text-xs mb-2 font-mono uppercase" placeholder="CLAVE CURP" value={data.curp} onChange={e=>setData({...data, curp:e.target.value.toUpperCase()})}/><input className="w-full border p-2 text-xs mb-2 uppercase" placeholder="Nombre(s)" value={data.nombre} onChange={e=>setData({...data, nombre:e.target.value.toUpperCase()})}/><div className="grid grid-cols-2 gap-2"><input className="border p-2 text-xs uppercase" placeholder="Primer Apellido" value={data.primerApellido} onChange={e=>setData({...data, primerApellido:e.target.value.toUpperCase()})}/><input className="border p-2 text-xs uppercase" placeholder="Segundo Apellido" value={data.segundoApellido} onChange={e=>setData({...data, segundoApellido:e.target.value.toUpperCase()})}/></div></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Detalles</p><div className="grid grid-cols-2 gap-2 mb-2"><input className="border p-2 text-xs uppercase" placeholder="Sexo (HOMBRE/MUJER)" value={data.sexo} onChange={e=>setData({...data, sexo:e.target.value.toUpperCase()})}/><input className="border p-2 text-xs uppercase" placeholder="Fecha Nacimiento" value={data.fechaNac} onChange={e=>setData({...data, fechaNac:e.target.value.toUpperCase()})}/></div><input className="w-full border p-2 text-xs mb-2 uppercase" placeholder="Entidad Nacimiento" value={data.entidad} onChange={e=>setData({...data, entidad:e.target.value.toUpperCase()})}/></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Registro</p><div className="grid grid-cols-2 gap-2"><input className="border p-2 text-xs uppercase" placeholder="Folio" value={data.folio} onChange={e=>setData({...data, folio:e.target.value})}/><input className="border p-2 text-xs uppercase" placeholder="Fecha Inscripci√≥n" value={data.fechaInscripcion} onChange={e=>setData({...data, fechaInscripcion:e.target.value})}/></div></div>
                        </div>
                    </div>
                    {/* PANEL DERECHO: VISTA PREVIA CURP */}
                    <div className="w-full lg:w-2/3 bg-gray-200 flex justify-center p-6 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] relative text-black shadow-2xl border-t-[8px] border-[#0b5c46]">
                             {/* CABECERA VERDE */}
                             <div className="flex justify-between items-center p-4 pb-0">
                                <div className="w-1/4"><div className="text-[9px] font-bold text-gray-500 uppercase tracking-widest">Estados Unidos Mexicanos</div><div className="h-12 w-12 bg-contain bg-no-repeat opacity-80" style={{backgroundImage: "url('https://upload.wikimedia.org/wikipedia/commons/2/2a/Coat_of_arms_of_Mexico.svg')"}}></div></div>
                                <div className="w-2/4 text-center"><h1 className="text-xl font-bold text-[#0b5c46] uppercase tracking-wide">Clave √önica de Registro de Poblaci√≥n</h1></div>
                                <div className="w-1/4 flex flex-col items-end"><div className="h-10 w-24 bg-contain bg-no-repeat bg-right" style={{backgroundImage: "url('https://framework-gb.cdn.gob.mx/landing/img/logo_segob.svg')"}}></div></div>
                             </div>
                             {/* CONTENIDO PRINCIPAL */}
                             <div className="p-8 pt-2 relative z-10">
                                <div className="border border-gray-300 rounded-lg p-4 bg-gray-50/50 mb-4 flex justify-between items-center shadow-sm">
                                    <div><p className="text-[10px] text-gray-400 font-bold uppercase mb-1">Clave:</p><p className="text-2xl font-black text-[#333] tracking-widest font-mono">{data.curp || 'XXXXXXXXXXXXXXXXXX'}</p></div>
                                    <div className="text-right"><p className="text-[9px] text-gray-400 font-bold uppercase">Folio</p><p className="text-sm font-bold text-gray-600">{data.folio}</p></div>
                                </div>
                                <div className="grid grid-cols-4 gap-6 mb-6">
                                    <div className="col-span-4 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Nombre</p><p className="text-sm font-bold uppercase text-gray-800">{data.nombre} {data.primerApellido} {data.segundoApellido}</p></div>
                                    <div className="col-span-1 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Fecha de Inscripci√≥n</p><p className="text-xs font-bold uppercase text-gray-800">{data.fechaInscripcion}</p></div>
                                    <div className="col-span-2 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Entidad de Registro</p><p className="text-xs font-bold uppercase text-gray-800">{data.entidad}</p></div>
                                    <div className="col-span-1 border-b border-gray-200 pb-1"></div>
                                </div>
                                {/* C√ìDIGO DE BARRAS Y QR */}
                                <div className="flex justify-between items-end border-t-2 border-gray-100 pt-4">
                                    <div className="flex flex-col gap-1 w-2/3">
                                        <div className="flex items-end h-10 w-full overflow-hidden gap-[1px] opacity-70">{barcode.map((w,i)=><div key={i} style={{width:w, height: Math.random()>0.5?'100%':'80%'}} className="bg-black"></div>)}</div>
                                        <p className="text-[8px] text-gray-400 text-center font-mono tracking-[0.5em]">{data.curp}</p>
                                    </div>
                                    <div className="w-24 h-24 border border-gray-200 p-1 bg-white"><img src={qrCode} className="w-full h-full"/></div>
                                </div>
                                <div className="mt-4 text-[7px] text-gray-400 text-justify">La Clave √önica de Registro de Poblaci√≥n (CURP) es un instrumento de registro que se asigna a todas las personas que viven en el territorio nacional, as√≠ como a los mexicanos que residen en el extranjero. El presente documento es una constancia de su asignaci√≥n.</div>
                             </div>
                             {/* MARCA DE AGUA */}
                             <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03] z-0"><div className="w-[400px] h-[400px] bg-black rounded-full"></div></div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // EDITOR INCAPACIDAD IMSS (CLON)
        // ==========================================
        const IncapacityEditor = ({ onNavigate, user }) => {
            const [data, setData] = useState({
                folio: 'YP546827', nss: '05209874840', agregado: '1F1999OR',
                nombre: 'RICARDO DE JESUS LOPEZ MONTOYA', curp: 'LOMR980622HMCPNC01', sexo: 'MASCULINO',
                delegacion: 'TOLUCA DE LERDO, M√âX.', unidad: 'UMF 222', cvePtal: 'C121491310',
                consultorio: '3', turno: 'MATUTINO', documentoId: 'CARTILLA DE SALUD Y CITAS MEDICAS',
                numId: 'FOLIO 1772116958218', expedidora: 'UMF 222 Toluca de lerdo',
                adscripcion: 'UMF 222 Toluca de lerdo', servicio: 'MEDICINA FAMILIAR',
                dias: '2', aPartir: '16/12/2025', expedido: '16/12/2025', probableRiesgo: 'SI',
                ramo: 'Enfermedad General', tipo: 'INICIAL', medico: 'Fernando A. Torres Lino', matricula: '99268536'
            });

            // Generador visual de c√≥digo de barras
            const BarcodeStrip = ({ className }) => (
                <div className={`flex items-stretch overflow-hidden select-none ${className}`}>
                    {Array(80).fill(0).map((_, i) => (
                        <div key={i} style={{ width: Math.random() > 0.6 ? '4px' : '2px', backgroundColor: 'black', marginRight: Math.random() > 0.5 ? '2px' : '0px' }} className="h-full"></div>
                    ))}
                </div>
            );

            const update = (field, val) => setData(prev => ({ ...prev, [field]: val.toUpperCase() }));
                        const handleSave = async () => { 
                try { 
                    await db.collection('incapacidades_history').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ Incapacidad Guardada"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); } 
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* PANEL IZQUIERDO: FORMULARIO */}
                    <div className="w-full lg:w-1/3 bg-white border-r p-4 h-screen overflow-y-auto no-print z-50 shadow-xl">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar Incapacidad</h2>
                            <div className="flex gap-2"><button onClick={handleSave} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button><button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Encabezado</p><input className="w-full border p-2 text-xs mb-1 font-bold" placeholder="Folio" value={data.folio} onChange={e=>update('folio',e.target.value)} /><input className="w-full border p-2 text-xs mb-1" placeholder="NSS" value={data.nss} onChange={e=>update('nss',e.target.value)} /><input className="w-full border p-2 text-xs mb-1" placeholder="Nombre" value={data.nombre} onChange={e=>update('nombre',e.target.value)} /><input className="w-full border p-2 text-xs" placeholder="CURP" value={data.curp} onChange={e=>update('curp',e.target.value)} /></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Detalles M√©dicos</p><div className="grid grid-cols-2 gap-2 mb-2"><input className="border p-2 text-xs" placeholder="D√≠as" value={data.dias} onChange={e=>update('dias',e.target.value)} /><input className="border p-2 text-xs" placeholder="A partir de" value={data.aPartir} onChange={e=>update('aPartir',e.target.value)} /></div><input className="w-full border p-2 text-xs mb-1" placeholder="Ramo Seguro" value={data.ramo} onChange={e=>update('ramo',e.target.value)} /><input className="w-full border p-2 text-xs mb-1" placeholder="M√©dico" value={data.medico} onChange={e=>update('medico',e.target.value)} /><input className="w-full border p-2 text-xs" placeholder="Matr√≠cula" value={data.matricula} onChange={e=>update('matricula',e.target.value)} /></div>
                        </div>
                    </div>

                    {/* PANEL DERECHO: VISTA PREVIA (CLON) */}
                    <div className="w-full lg:w-2/3 bg-gray-200 flex justify-center p-6 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] p-8 relative text-black shadow-2xl text-[10px] font-sans leading-tight">
                            {/* MARCA DE AGUA */}
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/IMSS_Logosymbol.svg" className="w-[80%] opacity-[0.08] grayscale" /></div>
                            
                            {/* CONTENIDO SUPERIOR */}
                            <div className="relative z-10">
                                <div className="text-right text-xs mb-4">Pagina 1 de 3</div>
                                <div className="font-bold mb-2 text-xs">Incapacidad</div>
                                <div className="flex justify-between items-start mb-2">
                                    <div className="w-2/5 flex items-center gap-2">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/IMSS_Logosymbol.svg" className="h-12" />
                                        <div className="font-bold text-[8px]"><div>INSTITUTO MEXICANO DEL SEGURO SOCIAL</div><div>SEGURIDAD Y SOLIDARIDAD SOCIAL</div></div>
                                    </div>
                                    <div className="w-3/5 text-center pt-2">
                                        <div className="font-bold border-t border-gray-400 pt-1 text-[11px]">DIRECCION DE PRESTACIONES M√âDICAS</div>
                                        <div className="font-black text-lg font-serif mt-1">CERTIFICADO DE INCAPACIDAD</div>
                                    </div>
                                </div>

                                {/* CAJA NEGRA DATOS DERECHA */}
                                <div className="absolute top-8 right-0 w-[45%] border-[3px] border-black p-1 bg-white/90">
                                    <div className="flex justify-between font-bold"><span>NS: {data.nss}</span><span>AGREGADO MEDICO: {data.agregado}</span></div>
                                    <div className="text-center font-bold mt-1">NOMBRE DEL ASEGURADO:<br/>{data.nombre}</div>
                                    <div className="flex justify-between mt-1"><span>CURP: {data.curp}</span><span>SEXO:</span></div>
                                    <div className="font-bold">{data.sexo}</div>
                                    <div className="mt-1">DELEGACION: {data.delegacion}</div>
                                    <div className="flex justify-between"><span>UNIDAD: {data.unidad}</span><span>CVE PTAL: {data.cvePtal}</span></div>
                                    <div className="flex justify-between mt-1"><span className="w-1/2">CONSULTORIO: {data.consultorio}</span><span className="w-1/2">TURNO: {data.turno}</span></div>
                                    <div className="mt-1">DOCUMENTO IDENTIFICACION DEL ASEGURADO: {data.documentoId}</div>
                                    <div>NUMERO DE IDENTIFICACION: {data.numId}</div>
                                </div>

                                {/* CODIGO BARRAS SUPERIOR */}
                                <div className="mt-20 w-1/2 mb-1">
                                    <BarcodeStrip className="h-10 w-full" />
                                </div>

                                {/* BARRA GRIS FOLIO */}
                                <div className="bg-gray-300 w-full text-right font-bold text-sm pr-2 py-0.5 border-t border-b border-gray-400 mb-0.5">Serie y Folio {data.folio}</div>

                                {/* TABLA DE DATOS CENTRAL */}
                                <div className="flex border-b-2 border-blue-300 pb-1 mb-2">
                                    <div className="w-1/4 pr-1 border-r border-gray-300">
                                        <div className="font-bold">Unidad Medica Expedidora</div>
                                        <div>{data.expedidora}</div>
                                        <div className="font-bold mt-2">Adscripci√≥n</div>
                                        <div>{data.adscripcion}</div>
                                        <div className="mt-2"><span className="font-bold">Ramo de Seguro</span> {data.ramo}</div>
                                        <div><span className="font-bold">Probable Riesgo Trabajo</span> {data.probableRiesgo}</div>
                                    </div>
                                    <div className="w-1/4 px-1 border-r border-gray-300">
                                        <div className="font-bold">Nivel de atenci√≥n 1</div>
                                        <div className="font-bold mt-2">Delegaci√≥n Adscripci√≥n</div>
                                        <div>Toluca de lerdo Dias</div>
                                        <div className="font-bold">Autorizados (letra)</div>
                                        <div className="capitalize">{['Cero','Uno','Dos','Tres','Cuatro'][parseInt(data.dias)] || data.dias}</div>
                                    </div>
                                    <div className="w-1/4 px-1 border-r border-gray-300">
                                        <div className="font-bold">Delegaci√≥n Expedidora</div>
                                        <div className="mt-4">3 Suroeste D.F.</div>
                                        <div className="font-bold">Patr√≥n(es) MIDELPE S.A. DE C.V.</div>
                                        <div className="mt-2 font-bold">N√∫mero 1 Control de Maternidad No D√≠as Acumulandos 0</div>
                                    </div>
                                    <div className="w-1/4 pl-1">
                                        <div className="font-bold">Certificado de Incapacidad en Serie</div>
                                        <div className="font-bold text-sm mt-2">{data.folio}</div>
                                        <div className="font-bold mt-1">Puesto de Trabajo:</div>
                                        <div>Ayudante general</div>
                                        <div className="font-bold mt-1">A partir del {data.aPartir}</div>
                                        <div className="font-bold">Expedido el {data.expedido}</div>
                                    </div>
                                </div>

                                {/* TEXTO LEGAL */}
                                <div className="text-[9px] text-justify mb-4 font-medium">
                                    <p className="font-bold mb-1">El incapacitado tiene derecho a subsidio:</p>
                                    <p>a) Si se trata de un riesgo de trabajo, desde el primer d√≠a de incapacidad.</p>
                                    <p>b) Si la incapacidad es causada por enfermedad no profesional a partir del 4¬∫ d√≠a de estar incapacitado, si tiene cubiertas por lo menos cuatro cotizaciones semanales inmediatamente anteriores a la enfermedad.</p>
                                    <p>c) Los trabajadores eventuales percibir√°n el subsidio cuando tengan reconocidas, cotizaciones semanales en los √∫ltimos cuatro meses anteriores a la enfermedad.</p>
                                    <p>d) En caso de maternidad, durante 42 d√≠as anteriores al parto y 42 d√≠as posteriores al mismo, si ha cubierto al menos 30 cotizaciones semanales en los 12 meses anteriores al inicio del pago del subsidio.</p>
                                </div>

                                {/* FIRMAS */}
                                <div className="flex justify-between items-end mt-8 relative">
                                    <div className="w-1/3 text-center">
                                        <div className="border-t border-black pt-1 font-bold">Nombre y firma del m√©dico</div>
                                        <div className="font-bold">{data.medico}</div>
                                        <div className="text-[9px] text-blue-800 font-bold border border-blue-800 inline-block px-1 mt-1 transform -rotate-2 bg-white/80 relative z-10">
                                            IMSS Matricula: {data.matricula}
                                        </div>
                                    </div>
                                    <div className="w-1/3 text-center">
                                        <div className="font-bold mb-8">Matricula {data.matricula}</div>
                                        <div className="font-bold text-lg">COPIA PATR√ìN</div>
                                    </div>
                                    <div className="w-1/3 text-center">
                                        <div className="border-t border-black pt-1 font-bold">Nombre y firma del m√©dico que autoriza</div>
                                        <div>NO APLICA</div>
                                    </div>
                                </div>

                                {/* PIE DE PAGINA */}
                                <div className="mt-4 text-[9px]">
                                    <p>Ahora tambi√©n es posible registrar tu cuenta bancaria pararecibir el pago de tu subsidio por incapacidad acude a la ventanilla de control de prestaciones de tu cl√≠nica de adscripci√≥n con los siguientes documentos en original y copia.</p>
                                    <ul className="list-decimal list-inside">
                                        <li>Estado de cuenta bancaria con cuenta clave.</li>
                                        <li>Identificaci√≥n oficial vigente.</li>
                                        <li>Documento de NSS</li>
                                        <li>Cuenta con firma electr√≥nica (FIEL) tambi√©n puedes realizar el tr√°mite por internet desde el escritorio virtual</li>
                                    </ul>
                                </div>

                                <div className="text-right mt-8 font-bold">Fecha de Impresi√≥n: {new Date().toLocaleDateString('es-MX')}</div>
                            </div>

                            {/* CODIGO BARRAS LATERAL DERECHO */}
                            <div className="absolute right-2 bottom-4 top-1/2 h-[40%] w-8 flex flex-col justify-end">
                                <BarcodeStrip className="w-full h-full rotate-180 flex-col" />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // EDITOR COMPROBANTE CFE (CLON)
        // ==========================================
        const CfeEditor = ({ onNavigate, user }) => {
            const [data, setData] = useState({
                nombre: 'RICARDO LOPEZ MONTOYA', direccion: 'AV. PASEO DE LA REFORMA 123, COL. CENTRO',
                ciudad: 'CIUDAD DE MEXICO, CDMX, C.P. 06000', noServicio: '123456789012',
                rmu: '12345 67-89-01 XX000 010101 001 CFE', tarifa: '1', medidor: '987654',
                total: '584', periodo: '15 DIC 24 - 15 FEB 25', limitePago: '01 MAR 25',
                corte: '02 MAR 25', lecturaActual: '09852', lecturaAnt: '09500',
                consumo: '352', apoyo: '150.50', subtotal: '488.23', iva: '95.77'
            });

            const update = (field, val) => setData(prev => ({ ...prev, [field]: val.toUpperCase() }));
                        const handleSave = async () => { 
                try { 
                    await db.collection('cfe_history').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ Recibo Guardado"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); } 
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* PANEL IZQUIERDO: FORMULARIO */}
                    <div className="w-full lg:w-1/3 bg-white border-r p-4 h-screen overflow-y-auto no-print z-50 shadow-xl">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar Recibo Luz</h2>
                            <div className="flex gap-2"><button onClick={handleSave} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button><button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Cliente</p><input className="w-full border p-2 text-xs mb-1" placeholder="Nombre" value={data.nombre} onChange={e=>update('nombre',e.target.value)} /><input className="w-full border p-2 text-xs mb-1" placeholder="Direcci√≥n" value={data.direccion} onChange={e=>update('direccion',e.target.value)} /><input className="w-full border p-2 text-xs" placeholder="Ciudad/CP" value={data.ciudad} onChange={e=>update('ciudad',e.target.value)} /></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Datos Servicio</p><div className="grid grid-cols-2 gap-2 mb-2"><input className="border p-2 text-xs" placeholder="No. Servicio" value={data.noServicio} onChange={e=>update('noServicio',e.target.value)} /><input className="border p-2 text-xs" placeholder="Total a Pagar" value={data.total} onChange={e=>update('total',e.target.value)} /></div><input className="w-full border p-2 text-xs mb-1" placeholder="RMU" value={data.rmu} onChange={e=>update('rmu',e.target.value)} /><div className="grid grid-cols-2 gap-2"><input className="border p-2 text-xs" placeholder="L√≠mite Pago" value={data.limitePago} onChange={e=>update('limitePago',e.target.value)} /><input className="border p-2 text-xs" placeholder="Fecha Corte" value={data.corte} onChange={e=>update('corte',e.target.value)} /></div></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-green-700 uppercase mb-2">Consumo</p><div className="grid grid-cols-3 gap-2"><input className="border p-2 text-xs" placeholder="Lect. Actual" value={data.lecturaActual} onChange={e=>update('lecturaActual',e.target.value)} /><input className="border p-2 text-xs" placeholder="Lect. Ant" value={data.lecturaAnt} onChange={e=>update('lecturaAnt',e.target.value)} /><input className="border p-2 text-xs" placeholder="Periodo" value={data.periodo} onChange={e=>update('periodo',e.target.value)} /></div></div>
                        </div>
                    </div>

                    {/* PANEL DERECHO: VISTA PREVIA (CFE) */}
                    <div className="w-full lg:w-2/3 bg-gray-200 flex justify-center p-6 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-0 relative text-black shadow-2xl overflow-hidden">
                            {/* HEADER */}
                            <div className="bg-[#007935] h-3"></div>
                            <div className="px-8 pt-4 pb-2 flex justify-between items-start border-b border-gray-200">
                                <div className="w-1/2">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/CFE_Emblema.svg/1024px-CFE_Emblema.svg.png" className="h-12 mb-4" />
                                    <div className="text-[10px] font-bold text-gray-700 uppercase leading-snug">{data.nombre}</div>
                                    <div className="text-[9px] text-gray-600 uppercase leading-snug w-[80%]">{data.direccion}</div>
                                    <div className="text-[9px] text-gray-600 uppercase leading-snug">{data.ciudad}</div>
                                </div>
                                <div className="w-1/2 text-right">
                                    <div className="text-[10px] font-bold text-gray-500 uppercase">TOTAL A PAGAR:</div>
                                    <div className="text-3xl font-bold text-[#007935] mb-2">${data.total} <span className="text-[10px] text-black font-normal align-top">(M.N.)</span></div>
                                    <div className="grid grid-cols-2 gap-x-4 text-left text-[9px] border-t border-gray-200 pt-1">
                                        <div className="font-bold text-gray-500">NO. DE SERVICIO:</div>
                                        <div className="font-bold text-right">{data.noServicio}</div>
                                        <div className="font-bold text-gray-500">RMU:</div>
                                        <div className="font-bold text-right truncate">{data.rmu}</div>
                                        <div className="font-bold text-gray-500">L√çMITE DE PAGO:</div>
                                        <div className="font-bold text-right">{data.limitePago}</div>
                                        <div className="font-bold text-gray-500">CORTE A PARTIR:</div>
                                        <div className="font-bold text-right text-red-600">{data.corte}</div>
                                    </div>
                                </div>
                            </div>

                            {/* MIDDLE SECTION */}
                            <div className="px-8 py-2">
                                <div className="flex border-b border-gray-300 pb-2">
                                    <div className="w-2/3 border-r border-gray-300 pr-4">
                                        <div className="text-[8px] font-bold text-[#007935] uppercase mb-1">CONSUMO DE ENERG√çA EL√âCTRICA</div>
                                        <table className="w-full text-[8px] text-center mb-2">
                                            <thead className="bg-[#007935] text-white">
                                                <tr><th>Concepto</th><th>Lectura Actual</th><th>Lectura Anterior</th><th>Total Periodo</th><th>Precio</th><th>Subtotal</th></tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td className="border-b">Energ√≠a</td>
                                                    <td className="border-b font-bold">{data.lecturaActual}</td>
                                                    <td className="border-b font-bold">{data.lecturaAnt}</td>
                                                    <td className="border-b font-bold">{data.consumo}</td>
                                                    <td className="border-b">$1.025</td>
                                                    <td className="border-b font-bold">${data.subtotal}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        {/* GRAFICO FALSO */}
                                        <div className="h-24 w-full border border-gray-200 relative flex items-end justify-around p-2">
                                            <div className="w-4 bg-green-200 h-[40%]"></div>
                                            <div className="w-4 bg-green-300 h-[60%]"></div>
                                            <div className="w-4 bg-green-400 h-[30%]"></div>
                                            <div className="w-4 bg-green-500 h-[50%]"></div>
                                            <div className="w-4 bg-[#007935] h-[80%] relative"><div className="absolute -top-3 left-0 w-full text-center text-[6px] font-bold">{data.consumo}</div></div>
                                            <div className="absolute top-1 left-2 text-[6px] text-gray-400">Historial de Consumo (kWh)</div>
                                        </div>
                                    </div>
                                    <div className="w-1/3 pl-4">
                                        <div className="text-[8px] font-bold text-[#007935] uppercase mb-1">COSTOS DE LA ENERG√çA</div>
                                        <div className="text-[8px] space-y-1 border-b border-gray-300 pb-2 mb-2">
                                            <div className="flex justify-between"><span>Suministro</span><span>$85.20</span></div>
                                            <div className="flex justify-between"><span>Distribuci√≥n</span><span>$142.10</span></div>
                                            <div className="flex justify-between"><span>Transmisi√≥n</span><span>$65.33</span></div>
                                            <div className="flex justify-between"><span>CENACE</span><span>$12.50</span></div>
                                            <div className="flex justify-between"><span>Energ√≠a</span><span>${(parseFloat(data.subtotal)-305).toFixed(2)}</span></div>
                                            <div className="flex justify-between"><span>Capacidad</span><span>$0.00</span></div>
                                            <div className="flex justify-between"><span>SCnMEM</span><span>$5.10</span></div>
                                        </div>
                                        <div className="bg-gray-100 p-2 rounded">
                                            <div className="flex justify-between text-[9px] font-bold"><span>Subtotal</span><span>${data.subtotal}</span></div>
                                            <div className="flex justify-between text-[9px] font-bold"><span>IVA 16%</span><span>${data.iva}</span></div>
                                            <div className="flex justify-between text-[11px] font-black text-[#007935] mt-1 border-t border-gray-300 pt-1"><span>Facturaci√≥n</span><span>${data.total}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* FOOTER */}
                            <div className="absolute bottom-0 w-full">
                                <div className="bg-[#007935] text-white text-[8px] px-8 py-1 flex justify-between">
                                    <span>Servicio a Clientes Tel√©fono 071</span>
                                    <span>www.cfe.mx</span>
                                </div>
                                <div className="px-8 py-2 flex items-center justify-between">
                                    <div className="w-2/3 h-10 flex flex-col justify-center border-t border-black pt-1">
                                        <div className="h-4 w-full bg-black/80 mb-1" style={{clipPath: 'polygon(0 0, 100% 0, 98% 100%, 2% 100%)'}}></div>
                                        <div className="text-[7px] font-mono">{data.noServicio}{data.rmu.replace(/\s/g,'')}</div>
                                    </div>
                                    <div className="w-24 h-24 border p-1 bg-white mb-2"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`CFE|${data.noServicio}|${data.total}|${data.limitePago}`)}`} className="w-full h-full"/></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // EDITOR CERTIFICADO SECUNDARIA (CLON SEP)
        // ==========================================
        const SecondaryCertificateEditor = ({ onNavigate, user }) => {
            const [data, setData] = useState({
                nombre: 'JUAN PEREZ LOPEZ', curp: 'PELJ050505HDFRRN01',
                escuela: 'ESCUELA SECUNDARIA TECNICA NO. 45', cct: '09DST0045K',
                promedio: '9.5', folio: 'A123456789', fecha: new Date().toLocaleDateString('es-MX'),
                autoridad: 'AUTORIDAD EDUCATIVA FEDERAL EN LA CIUDAD DE MEXICO',
                materias: [
                    { n: 'Lengua Materna. Espa√±ol', c: '10' }, { n: 'Matem√°ticas', c: '9' },
                    { n: 'Lengua Extranjera. Ingl√©s', c: '10' }, { n: 'Ciencias (Biolog√≠a, F√≠sica, Qu√≠mica)', c: '9' },
                    { n: 'Historia', c: '10' }, { n: 'Geograf√≠a', c: '9' },
                    { n: 'Formaci√≥n C√≠vica y √âtica', c: '10' }, { n: 'Artes', c: '10' },
                    { n: 'Tecnolog√≠a', c: '9' }, { n: 'Educaci√≥n F√≠sica', c: '10' }
                ]
            });

            const update = (f, v) => setData(p => ({ ...p, [f]: v.toUpperCase() }));
            const updateGrade = (i, val) => {
                const newM = [...data.materias];
                newM[i].c = val;
                setData({ ...data, materias: newM });
            };

            // Generar QR y Cadenas
            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`SEP|${data.folio}|${data.curp}|${data.promedio}`)}`;
            const selloDigital = Array(4).fill(0).map(() => Math.random().toString(36).substring(2)).join('').toUpperCase();

                        const handleSave = async () => { 
                try { 
                    await db.collection('cert_secundaria_history').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ Certificado Guardado"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); } 
            };

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100 font-sans">
                    {/* PANEL IZQUIERDO: FORMULARIO */}
                    <div className="w-full lg:w-1/3 bg-white border-r p-4 h-screen overflow-y-auto no-print z-50 shadow-xl">
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar Certificado</h2>
                            <div className="flex gap-2"><button onClick={handleSave} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button><button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button></div>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-gray-500 uppercase mb-2">Alumno</p><input className="w-full border p-2 text-xs mb-1" placeholder="Nombre Completo" value={data.nombre} onChange={e=>update('nombre',e.target.value)} /><input className="w-full border p-2 text-xs" placeholder="CURP" value={data.curp} onChange={e=>update('curp',e.target.value)} /></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-gray-500 uppercase mb-2">Escuela</p><input className="w-full border p-2 text-xs mb-1" placeholder="Nombre Escuela" value={data.escuela} onChange={e=>update('escuela',e.target.value)} /><div className="grid grid-cols-2 gap-2"><input className="border p-2 text-xs" placeholder="CCT" value={data.cct} onChange={e=>update('cct',e.target.value)} /><input className="border p-2 text-xs" placeholder="Promedio Final" value={data.promedio} onChange={e=>update('promedio',e.target.value)} /></div><input className="w-full border p-2 text-xs mt-1" placeholder="Autoridad Emisora" value={data.autoridad} onChange={e=>update('autoridad',e.target.value)} /></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="text-[10px] font-bold text-gray-500 uppercase mb-2">Calificaciones</p>{data.materias.map((m, i) => (<div key={i} className="flex justify-between items-center mb-1"><span className="text-[9px] w-3/4 truncate">{m.n}</span><input className="w-12 border p-1 text-xs text-center font-bold" value={m.c} onChange={e=>updateGrade(i,e.target.value)} /></div>))}</div>
                        </div>
                    </div>

                    {/* PANEL DERECHO: VISTA PREVIA (SEP) */}
                    <div className="w-full lg:w-2/3 bg-gray-200 flex justify-center p-6 print-area overflow-auto">
                        <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] p-10 relative text-black shadow-2xl border-[8px] border-[#d4af37] outline outline-1 outline-gray-300 m-2">
                             {/* MARCO GRIS */}
                             <div className="absolute inset-2 border-2 border-gray-200 pointer-events-none"></div>

                             {/* ENCABEZADO */}
                             <div className="flex justify-between items-start mb-6 relative z-10">
                                <div className="w-1/4"><img src="https://framework-gb.cdn.gob.mx/landing/img/logo_segob.svg" className="h-16 opacity-80" /></div>
                                <div className="w-2/4 text-center">
                                    <h1 className="text-sm font-bold text-gray-600 uppercase tracking-widest">Sistema Educativo Nacional</h1>
                                    <div className="text-[9px] text-gray-500 uppercase font-bold mt-1">Autoridad Educativa: {data.autoridad}</div>
                                    <h2 className="text-xl font-serif font-bold text-black uppercase mt-4">Certificado de Terminaci√≥n de Estudios</h2>
                                    <h3 className="text-lg font-serif text-gray-600 uppercase">Educaci√≥n Secundaria</h3>
                                </div>
                                <div className="w-1/4 text-right flex flex-col items-end">
                                    <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/SEP_Logo_2019.svg" className="h-12 mb-2" />
                                    <div className="text-[8px] text-gray-400 font-bold">FOLIO DIGITAL</div>
                                    <div className="text-[10px] font-mono text-red-700 font-bold">{data.folio}</div>
                                </div>
                             </div>

                             {/* CUERPO DEL TEXTO */}
                             <div className="text-xs text-justify leading-relaxed mb-6 px-4 relative z-10">
                                <p className="mb-4">
                                    Se certifica que <span className="font-bold text-sm uppercase">{data.nombre}</span>, con Clave √önica de Registro de Poblaci√≥n <span className="font-bold uppercase">{data.curp}</span>, curs√≥ y acredit√≥ la Educaci√≥n Secundaria en la escuela <span className="font-bold uppercase">{data.escuela}</span>, con Clave de Centro de Trabajo <span className="font-bold uppercase">{data.cct}</span>, seg√∫n el plan de estudios vigente.
                                </p>
                             </div>

                             {/* TABLA DE CALIFICACIONES */}
                             <div className="px-4 mb-6 relative z-10">
                                <div className="text-center font-bold text-xs uppercase mb-2 bg-gray-100 py-1">Calificaciones Finales por Asignatura</div>
                                <table className="w-full text-xs border-collapse">
                                    <thead>
                                        <tr className="border-b-2 border-gray-300">
                                            <th className="text-left py-1 uppercase text-[10px] text-gray-500">Asignatura / √Årea</th>
                                            <th className="text-center py-1 uppercase text-[10px] text-gray-500 w-24">Calificaci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {data.materias.map((m, i) => (
                                            <tr key={i} className="border-b border-gray-100">
                                                <td className="py-1.5 font-medium text-gray-700">{m.n}</td>
                                                <td className="py-1.5 text-center font-bold text-black">{m.c}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                             </div>

                             {/* PROMEDIO */}
                             <div className="flex justify-end px-4 mb-8 relative z-10">
                                <div className="bg-gray-100 px-6 py-3 rounded-lg border border-gray-200 text-center">
                                    <div className="text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-1">Promedio General</div>
                                    <div className="text-3xl font-black text-[#d4af37]">{data.promedio}</div>
                                </div>
                             </div>

                             {/* PIE DE PAGINA (SELLOS) */}
                             <div className="absolute bottom-10 left-0 w-full px-10">
                                <div className="flex items-end border-t border-gray-300 pt-6">
                                    <div className="w-32 h-32 bg-white border border-gray-200 p-1 mr-4">
                                        <img src={qrCode} className="w-full h-full" />
                                    </div>
                                    <div className="flex-1 text-[8px] text-gray-400 font-mono break-all leading-tight">
                                        <div className="mb-2">
                                            <span className="font-bold text-gray-600 block">SELLO DIGITAL AUTORIDAD EDUCATIVA:</span>
                                            {selloDigital}{selloDigital}
                                        </div>
                                        <div>
                                            <span className="font-bold text-gray-600 block">FECHA DE EXPEDICI√ìN:</span>
                                            <span className="text-black text-[10px] font-sans">{data.fecha}</span>
                                        </div>
                                        <div className="mt-2 text-[7px] text-justify font-sans text-gray-400">
                                            El presente documento electr√≥nico es v√°lido de conformidad con lo dispuesto en la Ley General de Educaci√≥n. Su autenticidad puede ser verificada en el portal del Sistema de Informaci√≥n y Gesti√≥n Educativa (SIGED).
                                        </div>
                                    </div>
                                </div>
                             </div>

                             {/* MARCA DE AGUA */}
                             <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.04] z-0">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fc/SEP_Logo_2019.svg" className="w-[80%]" />
                             </div>
                        </div>
                    </div>
                </div>
            );
        };
        
                // ==========================================
        // EDITOR INE (CLON ESPEJO 100% ID√âNTICO)
        // ==========================================
                const IneEditor = ({ onNavigate, user }) => {
            const isAdmin = user.email === "mrandroidtutorialeshd@gmail.com";
            const [data, setData] = useState({
                nombre: 'PEREZ', apellidoPaterno: 'LOPEZ', apellidoMaterno: 'JUAN',
                domicilio: 'CALLE 10 NO. 123, COL. CENTRO, CP 06000, CDMX',
                claveElector: 'PELJ900505HDFRRN01', curp: 'PELJ900505HDFRRN01',
                agnoRegistro: '2008', vigencia: '2018-2028', fechaNacimiento: '05/05/1990',
                seccion: '0100', sexo: 'H', emision: '2018',
                cic: '123456789', ocr: '1234567890123',
                fotoUrl: 'https://i.pravatar.cc/150?img=68', // Foto de ejemplo
                firmaUrl: 'https://upload.wikimedia.org/wikipedia/commons/a/a9/Firma_de_ejemplo.png' // Firma ejemplo
            });

            const update = (f, v) => setData(p => ({ ...p, [f]: v.toUpperCase() }));
                        const handleSave = async () => { 
                try { 
                    await db.collection('ine_history').add({ ...data, userId: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); 
                    alert("‚úÖ INE Guardada"); 
                    onNavigate('welcome'); // <--- TE ENV√çA AL INICIO
                } catch (e) { alert("Error"); } 
            };

            // Estilos para el fondo de seguridad (trama)
            const securityBg = {
                backgroundImage: `url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-1h20v-2H0v-1h20v-2H0V11l1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1V7l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1-1V4H0V3h20V1H0V0h20V.5l1 1 1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1V4h20V3H20V1h20V0H20v.5l1 1 1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1V7l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1-1V8h20v1H20v2h20v1H20v2h20v1H20v2.5l1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1v3l-1-1-1 1-1-1-1 1-1-1-1 1-1-1-1 1v-3H20v-1h20v-2H20v-1h20v-2H20v-2h20v-1H20v-2h20v-1H20V16l1 1 1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1v3l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1 1v-3H20v-1h20v-2H20v-1h20v-2H20v-2h20v-1H20V20.5z' fill='%23d63384' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E")`
            };

            const qrCode = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`${data.cic}|${data.claveElector}|${data.curp}`)}`;

            return (
                <div className={`flex flex-col ${isAdmin ? 'lg:flex-row' : ''} min-h-screen bg-slate-100 font-sans`}>
                    {/* PANEL IZQUIERDO: FORMULARIO */}
                    <div className={`w-full ${isAdmin ? 'lg:w-1/3' : 'max-w-2xl mx-auto shadow-xl rounded-b-3xl'} bg-white border-r p-4 h-screen overflow-y-auto no-print z-50`}>
                        <div className="flex justify-between items-center mb-4 sticky top-0 bg-white py-2 border-b z-10">
                            <button onClick={() => onNavigate('services')} className="p-2 bg-slate-100 rounded-full"><Icon name="arrow-left" size={20}/></button>
                            <h2 className="font-bold text-sm">Editar INE</h2>
                            <div className="flex gap-2">
                                <button onClick={handleSave} className="bg-green-600 text-white px-3 py-1 rounded text-xs font-bold">Guardar</button>
                                {isAdmin && <button onClick={()=>window.print()} className="bg-slate-800 text-white px-3 py-1 rounded text-xs font-bold">Imprimir</button>}
                            </div>
                        </div>
                        <div className="space-y-3 font-sans text-xs">
                            <div className="bg-slate-50 p-3 rounded border"><p className="font-bold text-[#d63384] mb-2">Datos Personales</p><input className="w-full border p-2 mb-1" placeholder="Apellidos" value={data.nombre} onChange={e=>update('nombre',e.target.value)} /><div className="grid grid-cols-2 gap-1"><input className="border p-2" placeholder="Apellido P." value={data.apellidoPaterno} onChange={e=>update('apellidoPaterno',e.target.value)} /><input className="border p-2" placeholder="Apellido M." value={data.apellidoMaterno} onChange={e=>update('apellidoMaterno',e.target.value)} /></div><textarea className="w-full border p-2 mt-1 h-16" placeholder="Domicilio Completo" value={data.domicilio} onChange={e=>update('domicilio',e.target.value)} /></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="font-bold text-[#d63384] mb-2">Datos de Registro</p><input className="w-full border p-2 mb-1" placeholder="Clave Elector" value={data.claveElector} onChange={e=>update('claveElector',e.target.value)} /><input className="w-full border p-2 mb-1" placeholder="CURP" value={data.curp} onChange={e=>update('curp',e.target.value)} /><div className="grid grid-cols-3 gap-1"><input className="border p-2" placeholder="A√±o Reg." value={data.agnoRegistro} onChange={e=>update('agnoRegistro',e.target.value)} /><input className="border p-2 col-span-2" placeholder="Vigencia" value={data.vigencia} onChange={e=>update('vigencia',e.target.value)} /></div></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="font-bold text-[#d63384] mb-2">Detalles</p><div className="grid grid-cols-3 gap-1 mb-1"><input className="border p-2 col-span-2" placeholder="Fecha Nac." value={data.fechaNacimiento} onChange={e=>update('fechaNacimiento',e.target.value)} /><input className="border p-2" placeholder="Secci√≥n" value={data.seccion} onChange={e=>update('seccion',e.target.value)} /></div><div className="grid grid-cols-2 gap-1"><input className="border p-2" placeholder="Sexo (H/M)" value={data.sexo} onChange={e=>update('sexo',e.target.value)} /><input className="border p-2" placeholder="Emisi√≥n" value={data.emision} onChange={e=>update('emision',e.target.value)} /></div></div>
                            <div className="bg-slate-50 p-3 rounded border"><p className="font-bold text-[#d63384] mb-2">Reverso</p><input className="w-full border p-2 mb-1" placeholder="CIC" value={data.cic} onChange={e=>update('cic',e.target.value)} /><input className="w-full border p-2" placeholder="OCR" value={data.ocr} onChange={e=>update('ocr',e.target.value)} /></div>
                        </div>
                    </div>

                    {/* PANEL DERECHO: VISTA PREVIA (SOLO ADMIN) */}
                    {isAdmin && (
                        <div className="w-full lg:w-2/3 bg-gray-300 flex flex-col items-center justify-center p-8 gap-8 print-area overflow-auto">
                            
                            {/* --- ANVERSO (FRENTE) --- */}
                            <div className="w-[85.6mm] h-[53.98mm] bg-white rounded-lg overflow-hidden shadow-xl relative" style={securityBg}>
                                 {/* Encabezado Rosa */}
                                 <div className="h-8 bg-gradient-to-r from-[#d63384] to-[#b22a6f] flex items-center px-2">
                                     <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Coat_of_arms_of_Mexico.svg/50px-Coat_of_arms_of_Mexico.svg.png" className="h-5 mr-1" />
                                     <div className="text-white font-bold text-[8px] leading-none">INSTITUTO NACIONAL ELECTORAL</div>
                                     <div className="text-white font-bold text-[8px] leading-none ml-auto">CREDENCIAL PARA VOTAR</div>
                                 </div>

                                 {/* Contenido Principal Frente */}
                                 <div className="flex p-2 relative">
                                     {/* Foto Izquierda */}
                                     <div className="w-[24mm] h-[32mm] bg-gray-200 mr-2 relative overflow-hidden border-[1px] border-gray-300 rounded-sm">
                                         <img src={data.fotoUrl} className="w-full h-full object-cover" alt="Foto" />
                                         <div className="absolute bottom-0 left-0 w-full text-center text-[6px] text-white font-bold bg-black/30">FOTOGRAF√çA</div>
                                     </div>

                                     {/* Datos Texto */}
                                     <div className="flex-1 font-sans text-[8px] text-gray-800 relative z-10">
                                         <div className="font-bold text-[9px]">{data.nombre}</div>
                                         <div className="font-bold text-[9px]">{data.apellidoPaterno}</div>
                                         <div className="font-bold text-[9px] mb-1">{data.apellidoMaterno}</div>
                                         
                                         <div className="text-[7px] text-gray-500 font-bold">DOMICILIO</div>
                                         <div className="leading-tight font-semibold w-[90%]">{data.domicilio}</div>

                                         <div className="grid grid-cols-2 mt-1 gap-x-2">
                                             <div><span className="text-[7px] text-gray-500 font-bold block">CLAVE DE ELECTOR</span><span className="font-bold text-[9px]">{data.claveElector}</span></div>
                                             <div className="relative">
                                                 <span className="text-[7px] text-gray-500 font-bold block">CURP</span><span className="font-bold text-[9px]">{data.curp}</span>
                                                 {/* Microtexto de seguridad simulado */}
                                                 <div className="absolute -right-8 top-4 w-24 text-[4px] text-[#d63384]/30 font-mono rotate-90 pointer-events-none">INSTITUTONACIONALELECTORAL</div>
                                             </div>
                                         </div>

                                         <div className="flex justify-between mt-1">
                                             <div><span className="text-[7px] text-gray-500 font-bold block">A√ëO DE REGISTRO</span><span className="font-bold">{data.agnoRegistro}</span></div>
                                             <div><span className="text-[7px] text-gray-500 font-bold block">VIGENCIA</span><span className="font-bold">{data.vigencia}</span></div>
                                         </div>

                                         <div className="flex justify-between mt-1 items-end">
                                             <div>
                                                 <div className="flex gap-2">
                                                    <div><span className="text-[7px] text-gray-500 font-bold block">FECHA DE NACIMIENTO</span><span className="font-bold">{data.fechaNacimiento}</span></div>
                                                    <div><span className="text-[7px] text-gray-500 font-bold block">SECCI√ìN</span><span className="font-bold text-[9px]">{data.seccion}</span></div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                     
                                     {/* Foto Fantasma y Holograma (Simulado) */}
                                     <div className="absolute right-1 top-12 w-[15mm] h-[20mm] opacity-30 grayscale z-0"><img src={data.fotoUrl} className="w-full h-full object-cover rounded-sm" /></div>
                                     <div className="absolute right-2 bottom-10 w-6 h-6 rounded-full bg-gradient-to-tr from-yellow-200 to-pink-200 opacity-60 mix-blend-overlay z-20 pointer-events-none"></div>
                                 </div>

                                 {/* Pie con Firma y Sexo */}
                                 <div className="absolute bottom-1 left-2 right-2 flex justify-between items-end">
                                     <div className="flex gap-4">
                                        <div><span className="text-[7px] text-gray-500 font-bold block">SEXO</span><span className="font-bold">{data.sexo}</span></div>
                                        <div className="mt-0.5"><img src={data.firmaUrl} className="h-4 grayscale" alt="Firma" /></div>
                                     </div>
                                     <div><span className="text-[7px] text-gray-500 font-bold block">EMISI√ìN</span><span className="font-bold">{data.emision}</span></div>
                                 </div>
                                 
                                 {/* Patr√≥n ondulado inferior */}
                                 <div className="absolute bottom-0 left-0 w-full h-2 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRaD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiPjxwYXRoIGQ9Ik0wLDYwIEMxNTAsMTUwIDM1MCwwIDUwMCw2MCBDNjUwLDEyMCA4NTAsMzAgMTAwMCw2MCBMMTAwMCwxMDAgTDAsMTAwIFoiIGZpbGw9IiNkNjMzODQiIG9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')] bg-cover bg-bottom pointer-events-none z-0"></div>
                            </div>

                            {/* --- REVERSO (ATR√ÅS) --- */}
                            <div className="w-[85.6mm] h-[53.98mm] bg-white rounded-lg overflow-hidden shadow-xl relative flex font-sans" style={securityBg}>
                                {/* Izquierda: C√≥digos y Logo */}
                                <div className="w-1/3 p-2 flex flex-col justify-between border-r border-gray-200 border-dashed bg-gray-50/50">
                                    <div className="mt-1"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/INE_logo.svg/1200px-INE_logo.svg.png" className="h-6 mx-auto" /></div>
                                    <div className="flex justify-center my-2"><img src={qrCode} className="w-16 h-16 border p-0.5 bg-white" /></div>
                                    <div className="text-center">
                                        <div className="font-bold text-[8px] mb-1">CIC {data.cic}</div>
                                        <div className="font-bold text-[8px]">OCR {data.ocr}</div>
                                    </div>
                                </div>

                                {/* Derecha: Huellas y Marcas */}
                                <div className="w-2/3 p-2 relative">
                                    {/* Tira superior de microtexto */}
                                    <div className="absolute top-2 left-2 right-2 h-4 border-b border-gray-300 text-[4px] text-gray-400 tracking-widest overflow-hidden leading-none text-justify" style={{wordBreak:'break-all'}}>
                                        INSTITUTONACIONALELECTORALCREDENCIALPARAVOTARINSTITUTONACIONALELECTORALCREDENCIALPARAVOTARINSTITUTONACIONALELECTORALCREDENCIALPARAVOTAR
                                    </div>
                                    
                                    {/* √Årea de Huellas */}
                                    <div className="flex justify-around mt-8">
                                        <div className="w-12 h-16 border border-gray-300 rounded-sm flex items-center justify-center bg-gray-100/50 relative">
                                            <span className="text-[6px] text-gray-400 absolute bottom-0.5">HUELLA D√ÅCTILAR</span>
                                            <div className="w-8 h-10 rounded-full bg-gray-300 opacity-20 mix-blend-multiply animate-pulse"></div>
                                        </div>
                                        <div className="w-12 h-16 border border-gray-300 rounded-sm flex items-center justify-center bg-gray-100/50 relative">
                                            <span className="text-[6px] text-gray-400 absolute bottom-0.5">HUELLA D√ÅCTILAR</span>
                                            <div className="w-8 h-10 rounded-full bg-gray-300 opacity-20 mix-blend-multiply animate-pulse"></div>
                                        </div>
                                    </div>
                                    
                                    {/* C√≥digo de barras inferior (simulado) */}
                                    <div className="absolute bottom-2 left-2 right-2 h-6 flex items-stretch opacity-70">
                                        {Array(60).fill(0).map((_, i) => (
                                            <div key={i} style={{ width: Math.random() > 0.5 ? '2px' : '1px', backgroundColor: 'black', marginRight: Math.random() > 0.3 ? '1px' : '0px' }} className="h-full"></div>
                                        ))}
                                    </div>

                                    {/* Logotipo peque√±o esquina inferior derecha */}
                                    <div className="absolute bottom-1 right-1 w-5 h-5 bg-[#d63384] rounded-full flex items-center justify-center text-white font-bold text-[5px] opacity-80">INE</div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
                // ==========================================
        // PANTALLA: PDF GENERADOS (HISTORIAL DOCUMENTOS)
        // ==========================================
                // ==========================================
                // ==========================================
        // PANTALLA: PDF GENERADOS (CON HORA VISIBLE)
        // ==========================================
        const GeneratedDocsScreen = ({ onNavigate, user }) => {
            const [docs, setDocs] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedDoc, setSelectedDoc] = useState(null);

            useEffect(() => {
                const loadDocuments = async () => {
                    if (!user) return;
                    setLoading(true);
                    
                    const collectionsConfig = [
                        { name: 'recetas_imss', label: 'Receta IMSS', icon: 'file-heart', typeKey: 'recipe' },
                        { name: 'notas_remision', label: 'Nota Remisi√≥n', icon: 'receipt', typeKey: 'note' },
                        { name: 'ine_history', label: 'INE', icon: 'users', typeKey: 'ine' },
                        { name: 'actas_nacimiento', label: 'Acta Nacimiento', icon: 'baby', typeKey: 'birth' },
                        { name: 'curp_history', label: 'CURP', icon: 'shield', typeKey: 'curp' },
                        { name: 'incapacidades_history', label: 'Incapacidad', icon: 'briefcase', typeKey: 'incapacity' },
                        { name: 'cfe_history', label: 'Recibo Luz', icon: 'tv', typeKey: 'cfe' },
                        { name: 'cert_secundaria_history', label: 'Cert. Secundaria', icon: 'box', typeKey: 'secondary' }
                    ];

                    let allDocs = [];
                    try {
                        const promises = collectionsConfig.map(async (col) => {
                            const snap = await db.collection(col.name).where('userId', '==', user.uid).get();
                            return snap.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data(),
                                _typeLabel: col.label,
                                _icon: col.icon,
                                _typeKey: col.typeKey,
                                _date: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date()
                            }));
                        });
                        const results = await Promise.all(promises);
                        allDocs = results.flat().sort((a, b) => b._date - a._date);
                    } catch (error) { console.error("Error cargando documentos:", error); }
                    setDocs(allDocs);
                    setLoading(false);
                };
                loadDocuments();
            }, [user]);

            // Efecto para Auto-Imprimir al seleccionar
            useEffect(() => {
                if (selectedDoc) {
                    const timer = setTimeout(() => window.print(), 800);
                    return () => clearTimeout(timer);
                }
            }, [selectedDoc]);

            // CAMBIO AQU√ç: Se agreg√≥ la hora y minutos al formato
            const formatDate = (date) => {
                return date.toLocaleString('es-MX', { 
                    day: 'numeric', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            // --- RENDERIZADORES DE DOCUMENTOS ---
            const BarcodeStrip = ({ className }) => (<div className={`flex items-stretch overflow-hidden select-none ${className}`}>{Array(80).fill(0).map((_, i) => (<div key={i} style={{ width: Math.random() > 0.6 ? '4px' : '2px', backgroundColor: 'black', marginRight: Math.random() > 0.5 ? '2px' : '0px' }} className="h-full"></div>))}</div>);
            
            const DocumentViewer = ({ data }) => {
                const logoUrl = "https://i.postimg.cc/gJ8kqq0g/1766127957062.png";
                
                switch (data._typeKey) {
                    case 'recipe':
                        const qrContentRecipe = `Nombre: ${data.paciente.nombre}\nNSS: ${data.paciente.nss}\nFolio: ${data.meta.folio}`;
                        const qrCodeRecipe = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrContentRecipe)}`;
                        return (
                            <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-8 relative text-black border border-gray-100 mx-auto transform scale-[0.8] origin-top md:scale-100"><div className="flex justify-between items-start"><div className="w-[55%] pr-2"><div className="flex flex-col items-center mb-1"><img src={logoUrl} className="h-10 w-auto mb-1 opacity-90" /><h1 className="text-[10px] font-bold tracking-wide text-center leading-none">INSTITUTO MEXICANO DEL SEGURO SOCIAL</h1><p className="text-[5px] font-bold tracking-[0.2em] text-gray-500 mt-0.5 uppercase">Seguridad y Solidaridad Social</p></div><div className="w-full border-t border-b border-gray-400 py-0.5 my-2 text-center text-[7px] uppercase">Direcci√≥n de Prestaciones M√©dicas</div><div className="text-center mb-2"><h2 className="text-xl font-bold font-[Tinos] uppercase tracking-wide">Receta Individual</h2></div><div className="flex items-center justify-center gap-4 px-1"><div className="barcode"></div><div className="text-left leading-[1.1]"><div className="text-sm font-bold text-gray-900 mb-0.5 whitespace-nowrap">Folio: <span className="text-black text-sm font-black tracking-tight ml-1">{data.meta.folio}</span></div><div className="text-[10px] font-bold text-black uppercase max-w-[160px]">ESTA RECETA NO SE SURTIR√Å DESPU√âS DE LAS 72 HORAS DE SU EXPEDICI√ìN</div></div></div></div><div className="w-[45%] pl-2 pt-2 relative"><div className="double-box pt-box w-full"><div className="flex justify-between mb-0.5"><div><span className="pt-label">NS:</span><span className="pt-val">{data.paciente.nss}</span></div><div><span className="pt-label">AGREGADO. MED:</span><span className="pt-val">{data.paciente.agregado}</span></div></div><div className="text-center mb-0.5"><span className="pt-label block w-full mb-px">NOMBRE DEL PACIENTE:</span><div className="pt-val uppercase">{data.paciente.nombre}</div></div><div className="mb-0.5"><span className="pt-label">CURP:</span><span className="pt-val">{data.paciente.curp}</span></div><div className="flex gap-2 mb-0.5"><div><span className="pt-label">SEXO:</span><span className="pt-val">{data.paciente.sexo}</span></div><div><span className="pt-label">FECHA DE NACIMIENTO:</span><span className="pt-val">{data.paciente.fechaNac}</span></div></div><div className="mb-0.5"><span className="pt-label">DELEGACION:</span><span className="pt-val">{data.paciente.delegacion}</span></div><div className="flex justify-between mb-0.5"><div className="flex gap-2"><div><span className="pt-label">UMP:</span><span className="pt-val">{data.paciente.ump}</span></div><div><span className="pt-label">CONSULTORIO:</span><span className="pt-val">{data.paciente.consultorio}</span></div></div></div><div className="flex justify-between items-end"><div><span className="pt-label">CVE.PTAL</span><span className="pt-val">{data.paciente.cve}</span></div><div className="text-right"><span className="pt-label">TURNO:</span><span className="pt-val">{data.paciente.turno}</span></div></div></div><img src={qrCodeRecipe} className="absolute -bottom-16 right-20 w-12 h-12" /></div></div><div className="double-box min-h-[500px] flex flex-col relative mt-2"><div className="flex justify-between items-center px-2 pt-1 text-[10px] font-bold uppercase"><div>FECHA: {data.meta.fecha}</div><div>Primer Nivel de Atenci√≥n</div></div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="p-2 flex-grow">{data.medicamentos && data.medicamentos.map(m => (<div key={m.id} className="med-item text-[10px] leading-snug"><div className="font-bold text-black px-1 mb-0.5">{m.text}</div><div className="border-b border-black w-auto mx-4 mb-1"></div><div className="pl-1 whitespace-pre-wrap">{m.ind}</div></div>))}</div><div className="border-t border-black mt-auto bg-white relative"><div className="pt-3 px-4 flex text-[9px] items-start relative z-20"><div className="w-[55%] pr-2 relative"><div className="flex flex-col items-start relative"><span className="font-bold mb-0.5 leading-none">Nombre y firma del m√©dico: {data.medico.nombre}</span><span className="font-bold uppercase leading-tight text-[8px] w-full">{data.medico.uni}</span></div></div><div className="w-[45%] flex justify-between items-start pl-4"><div className="flex flex-col items-start"><span className="font-bold mb-1 leading-none">C√©dula Profesional:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.cedula}</span></div><div className="flex flex-col items-end"><span className="font-bold mb-1 leading-none">Matr√≠cula:</span><span className="font-[Arimo] font-bold leading-none">{data.medico.matricula}</span></div></div></div><div className="doctor-stamp absolute top-[0px] left-[40px] z-30 pointer-events-none"><img src={logoUrl} className="stamp-logo" /><div className="text-left text-[8px]"><div>DR(A). {data.medico.nombre}</div><div>{data.medico.tipo}</div><div>CED. PROF. {data.medico.cedula}</div><div>MATRICULA {data.medico.matricula}</div></div></div><div className="border-b border-black w-auto mx-4 mt-1 mb-1 relative z-10"></div><div className="h-20 w-full bg-white relative z-0 flex flex-col items-end justify-start px-4"><span className="font-bold text-[9px] uppercase mt-1">PACIENTE</span></div></div></div></div>
                        );
                    case 'note':
                        const total = data.items.reduce((acc, item) => acc + (item.cant * item.precio), 0);
                        return (
                            <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-12 relative text-black shadow-2xl mx-auto"><div className="flex justify-between items-end border-b-4 border-slate-800 pb-4 mb-8"><div><h1 className="text-4xl font-extrabold text-slate-900 tracking-tighter">NOTA DE REMISI√ìN</h1><p className="text-sm font-medium text-slate-500 mt-1">COMPROBANTE DE VENTA</p></div><div className="text-right"><div className="inline-block bg-red-50 border border-red-100 px-3 py-1 rounded mb-1"><span className="text-red-500 font-bold text-xs uppercase mr-2">Folio</span><span className="text-red-600 font-black text-xl font-mono">N¬∞ {data.folio}</span></div><div className="text-sm font-bold text-slate-800">{data.fecha}</div></div></div><div className="flex gap-8 mb-8 text-sm"><div className="flex-1 space-y-3"><div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-24 text-slate-500 uppercase text-[10px] pt-1">Cliente:</span> <span className="font-bold text-slate-800 uppercase flex-1">{data.cliente.nombre}</span></div><div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-24 text-slate-500 uppercase text-[10px] pt-1">Direcci√≥n:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.direccion}</span></div></div><div className="w-1/3 space-y-3"><div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-20 text-slate-500 uppercase text-[10px] pt-1">Ciudad:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.ciudad}</span></div><div className="flex border-b border-slate-200 border-dashed pb-1"><span className="font-bold w-20 text-slate-500 uppercase text-[10px] pt-1">Tel√©fono:</span> <span className="font-medium text-slate-700 uppercase flex-1">{data.cliente.telefono}</span></div></div></div><table className="w-full mb-8"><thead><tr className="bg-slate-900 text-white text-[10px] uppercase tracking-wider"><th className="py-2 px-2 text-center w-16 rounded-l">Cant.</th><th className="py-2 px-4 text-left">Descripci√≥n</th><th className="py-2 px-2 text-right w-24">Precio</th><th className="py-2 px-2 text-right w-24 rounded-r">Importe</th></tr></thead><tbody className="text-xs">{data.items.map((item, i) => (<tr key={i} className="border-b border-slate-100"><td className="py-3 text-center font-bold text-slate-600">{item.cant}</td><td className="py-3 px-4 font-medium text-slate-800 uppercase">{item.desc}</td><td className="py-3 text-right text-slate-500">${item.precio.toLocaleString()}</td><td className="py-3 text-right font-bold text-slate-900">${(item.cant * item.precio).toLocaleString()}</td></tr>))}[...Array(Math.max(0, 8 - data.items.length))].map((_, i) => (<tr key={'empty'+i} className="h-8 border-b border-slate-50"><td></td><td></td><td></td><td></td></tr>))</tbody></table><div className="flex justify-end"><div className="w-1/3 bg-slate-50 rounded-xl p-4 border border-slate-100"><div className="flex justify-between items-center text-slate-500 text-xs font-bold mb-2 uppercase"><span>Subtotal</span><span>${total.toLocaleString()}</span></div><div className="flex justify-between items-center text-slate-900 text-lg font-black border-t-2 border-slate-200 pt-2"><span>TOTAL</span><span>${total.toLocaleString()}</span></div></div></div><div className="absolute bottom-10 left-0 w-full text-center"><p className="text-[9px] text-slate-400 font-bold tracking-widest uppercase mb-1">Gracias por su preferencia</p><div className="w-16 h-1 bg-slate-100 mx-auto"></div></div></div>
                        );
                    case 'ine':
                        const qrCodeIne = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(`${data.cic}|${data.claveElector}|${data.curp}`)}`;
                        const securityBg = { backgroundImage: `url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 20.5V18H0v-1h20v-2H0v-1h20v-2H0V11l1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1V7l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1-1V4H0V3h20V1H0V0h20V.5l1 1 1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1V7l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1-1V8h20v1H20v2h20v1H20v2h20v1H20v2.5l1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1v3l-1-1-1 1-1-1-1 1-1-1-1 1-1-1-1 1v-3H20v-1h20v-2H20v-1h20v-2H20v-2h20v-1H20v-2h20v-1H20V16l1 1 1-1 1 1 1-1 1 1 1-1 1 1 1-1 1 1v3l-1 1-1-1-1 1-1-1-1 1-1-1-1 1-1-1 1v-3H20v-1h20v-2H20v-1h20v-2H20v-2h20v-1H20V20.5z' fill='%23d63384' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E")` };
                        return (
                            <div className="flex flex-col items-center gap-8 mx-auto">
                                <div className="w-[85.6mm] h-[53.98mm] bg-white rounded-lg overflow-hidden shadow-xl relative" style={securityBg}><div className="h-8 bg-gradient-to-r from-[#d63384] to-[#b22a6f] flex items-center px-2"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Coat_of_arms_of_Mexico.svg/50px-Coat_of_arms_of_Mexico.svg.png" className="h-5 mr-1" /><div className="text-white font-bold text-[8px] leading-none">INSTITUTO NACIONAL ELECTORAL</div><div className="text-white font-bold text-[8px] leading-none ml-auto">CREDENCIAL PARA VOTAR</div></div><div className="flex p-2 relative"><div className="w-[24mm] h-[32mm] bg-gray-200 mr-2 relative overflow-hidden border-[1px] border-gray-300 rounded-sm"><img src={data.fotoUrl} className="w-full h-full object-cover" /><div className="absolute bottom-0 left-0 w-full text-center text-[6px] text-white font-bold bg-black/30">FOTOGRAF√çA</div></div><div className="flex-1 font-sans text-[8px] text-gray-800 relative z-10"><div className="font-bold text-[9px]">{data.nombre}</div><div className="font-bold text-[9px]">{data.apellidoPaterno}</div><div className="font-bold text-[9px] mb-1">{data.apellidoMaterno}</div><div className="text-[7px] text-gray-500 font-bold">DOMICILIO</div><div className="leading-tight font-semibold w-[90%]">{data.domicilio}</div><div className="grid grid-cols-2 mt-1 gap-x-2"><div><span className="text-[7px] text-gray-500 font-bold block">CLAVE DE ELECTOR</span><span className="font-bold text-[9px]">{data.claveElector}</span></div><div className="relative"><span className="text-[7px] text-gray-500 font-bold block">CURP</span><span className="font-bold text-[9px]">{data.curp}</span><div className="absolute -right-8 top-4 w-24 text-[4px] text-[#d63384]/30 font-mono rotate-90 pointer-events-none">INSTITUTONACIONALELECTORAL</div></div></div><div className="flex justify-between mt-1"><div><span className="text-[7px] text-gray-500 font-bold block">A√ëO DE REGISTRO</span><span className="font-bold">{data.agnoRegistro}</span></div><div><span className="text-[7px] text-gray-500 font-bold block">VIGENCIA</span><span className="font-bold">{data.vigencia}</span></div></div><div className="flex justify-between mt-1 items-end"><div><div className="flex gap-2"><div><span className="text-[7px] text-gray-500 font-bold block">FECHA DE NACIMIENTO</span><span className="font-bold">{data.fechaNacimiento}</span></div><div><span className="text-[7px] text-gray-500 font-bold block">SECCI√ìN</span><span className="font-bold text-[9px]">{data.seccion}</span></div></div></div></div></div><div className="absolute right-1 top-12 w-[15mm] h-[20mm] opacity-30 grayscale z-0"><img src={data.fotoUrl} className="w-full h-full object-cover rounded-sm" /></div><div className="absolute right-2 bottom-10 w-6 h-6 rounded-full bg-gradient-to-tr from-yellow-200 to-pink-200 opacity-60 mix-blend-overlay z-20 pointer-events-none"></div></div><div className="absolute bottom-1 left-2 right-2 flex justify-between items-end"><div className="flex gap-4"><div><span className="text-[7px] text-gray-500 font-bold block">SEXO</span><span className="font-bold">{data.sexo}</span></div><div className="mt-0.5"><img src={data.firmaUrl} className="h-4 grayscale" /></div></div><div><span className="text-[7px] text-gray-500 font-bold block">EMISI√ìN</span><span className="font-bold">{data.emision}</span></div></div><div className="absolute bottom-0 left-0 w-full h-2 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRaD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwMCAxMDAiIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiPjxwYXRoIGQ9Ik0wLDYwIEMxNTAsMTUwIDM1MCwwIDUwMCw2MCBDNjUwLDEyMCA4NTAsMzAgMTAwMCw2MCBMMTAwMCwxMDAgTDAsMTAwIFoiIGZpbGw9IiNkNjMzODQiIG9wYWNpdHk9IjAuMSIvPjwvc3ZnPg==')] bg-cover bg-bottom pointer-events-none z-0"></div></div>
                                <div className="w-[85.6mm] h-[53.98mm] bg-white rounded-lg overflow-hidden shadow-xl relative flex font-sans" style={securityBg}><div className="w-1/3 p-2 flex flex-col justify-between border-r border-gray-200 border-dashed bg-gray-50/50"><div className="mt-1"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/13/INE_logo.svg/1200px-INE_logo.svg.png" className="h-6 mx-auto" /></div><div className="flex justify-center my-2"><img src={qrCodeIne} className="w-16 h-16 border p-0.5 bg-white" /></div><div className="text-center"><div className="font-bold text-[8px] mb-1">CIC {data.cic}</div><div className="font-bold text-[8px]">OCR {data.ocr}</div></div></div><div className="w-2/3 p-2 relative"><div className="absolute top-2 left-2 right-2 h-4 border-b border-gray-300 text-[4px] text-gray-400 tracking-widest overflow-hidden leading-none text-justify" style={{wordBreak:'break-all'}}>INSTITUTONACIONALELECTORALCREDENCIALPARAVOTARINSTITUTONACIONALELECTORALCREDENCIALPARAVOTARINSTITUTONACIONALELECTORALCREDENCIALPARAVOTAR</div><div className="flex justify-around mt-8"><div className="w-12 h-16 border border-gray-300 rounded-sm flex items-center justify-center bg-gray-100/50 relative"><span className="text-[6px] text-gray-400 absolute bottom-0.5">HUELLA D√ÅCTILAR</span><div className="w-8 h-10 rounded-full bg-gray-300 opacity-20 mix-blend-multiply animate-pulse"></div></div><div className="w-12 h-16 border border-gray-300 rounded-sm flex items-center justify-center bg-gray-100/50 relative"><span className="text-[6px] text-gray-400 absolute bottom-0.5">HUELLA D√ÅCTILAR</span><div className="w-8 h-10 rounded-full bg-gray-300 opacity-20 mix-blend-multiply animate-pulse"></div></div></div><div className="absolute bottom-2 left-2 right-2 h-6 flex items-stretch opacity-70">{Array(60).fill(0).map((_, i) => (<div key={i} style={{ width: Math.random() > 0.5 ? '2px' : '1px', backgroundColor: 'black', marginRight: Math.random() > 0.3 ? '1px' : '0px' }} className="h-full"></div>))}</div><div className="absolute bottom-1 right-1 w-5 h-5 bg-[#d63384] rounded-full flex items-center justify-center text-white font-bold text-[5px] opacity-80">INE</div></div></div>
                            </div>
                        );
                    case 'curp':
                        const qrCodeCurp = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`CURP:${data.curp}|NOMBRE:${data.nombre}|FOLIO:${data.folio}`)}`;
                        const barcode = Array(40).fill(0).map(() => Math.random() > 0.5 ? '3px' : '1px');
                        return (
                            <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] relative text-black shadow-2xl border-t-[8px] border-[#0b5c46] mx-auto"><div className="flex justify-between items-center p-4 pb-0"><div className="w-1/4"><div className="text-[9px] font-bold text-gray-500 uppercase tracking-widest">Estados Unidos Mexicanos</div><div className="h-12 w-12 bg-contain bg-no-repeat opacity-80" style={{backgroundImage: "url('https://upload.wikimedia.org/wikipedia/commons/2/2a/Coat_of_arms_of_Mexico.svg')"}}></div></div><div className="w-2/4 text-center"><h1 className="text-xl font-bold text-[#0b5c46] uppercase tracking-wide">Clave √önica de Registro de Poblaci√≥n</h1></div><div className="w-1/4 flex flex-col items-end"><div className="h-10 w-24 bg-contain bg-no-repeat bg-right" style={{backgroundImage: "url('https://framework-gb.cdn.gob.mx/landing/img/logo_segob.svg')"}}></div></div></div><div className="p-8 pt-2 relative z-10"><div className="border border-gray-300 rounded-lg p-4 bg-gray-50/50 mb-4 flex justify-between items-center shadow-sm"><div><p className="text-[10px] text-gray-400 font-bold uppercase mb-1">Clave:</p><p className="text-2xl font-black text-[#333] tracking-widest font-mono">{data.curp}</p></div><div className="text-right"><p className="text-[9px] text-gray-400 font-bold uppercase">Folio</p><p className="text-sm font-bold text-gray-600">{data.folio}</p></div></div><div className="grid grid-cols-4 gap-6 mb-6"><div className="col-span-4 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Nombre</p><p className="text-sm font-bold uppercase text-gray-800">{data.nombre} {data.primerApellido} {data.segundoApellido}</p></div><div className="col-span-1 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Fecha de Inscripci√≥n</p><p className="text-xs font-bold uppercase text-gray-800">{data.fechaInscripcion}</p></div><div className="col-span-2 border-b border-gray-200 pb-1"><p className="text-[9px] text-gray-400 font-bold uppercase">Entidad de Registro</p><p className="text-xs font-bold uppercase text-gray-800">{data.entidad}</p></div><div className="col-span-1 border-b border-gray-200 pb-1"></div></div><div className="flex justify-between items-end border-t-2 border-gray-100 pt-4"><div className="flex flex-col gap-1 w-2/3"><div className="flex items-end h-10 w-full overflow-hidden gap-[1px] opacity-70">{barcode.map((w,i)=><div key={i} style={{width:w, height: Math.random()>0.5?'100%':'80%'}} className="bg-black"></div>)}</div><p className="text-[8px] text-gray-400 text-center font-mono tracking-[0.5em]">{data.curp}</p></div><div className="w-24 h-24 border border-gray-200 p-1 bg-white"><img src={qrCodeCurp} className="w-full h-full"/></div></div><div className="mt-4 text-[7px] text-gray-400 text-justify">La Clave √önica de Registro de Poblaci√≥n (CURP) es un instrumento de registro que se asigna a todas las personas que viven en el territorio nacional, as√≠ como a los mexicanos que residen en el extranjero. El presente documento es una constancia de su asignaci√≥n.</div></div><div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.03] z-0"><div className="w-[400px] h-[400px] bg-black rounded-full"></div></div></div>
                        );
                    case 'incapacity':
                        return (
                            <div className="paper bg-white w-[21.59cm] min-h-[27.94cm] p-8 relative text-black shadow-2xl text-[10px] font-sans leading-tight mx-auto"><div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/IMSS_Logosymbol.svg" className="w-[80%] opacity-[0.08] grayscale" /></div><div className="relative z-10"><div className="text-right text-xs mb-4">Pagina 1 de 3</div><div className="font-bold mb-2 text-xs">Incapacidad</div><div className="flex justify-between items-start mb-2"><div className="w-2/5 flex items-center gap-2"><img src="https://upload.wikimedia.org/wikipedia/commons/9/9f/IMSS_Logosymbol.svg" className="h-12" /><div className="font-bold text-[8px]"><div>INSTITUTO MEXICANO DEL SEGURO SOCIAL</div><div>SEGURIDAD Y SOLIDARIDAD SOCIAL</div></div></div><div className="w-3/5 text-center pt-2"><div className="font-bold border-t border-gray-400 pt-1 text-[11px]">DIRECCION DE PRESTACIONES M√âDICAS</div><div className="font-black text-lg font-serif mt-1">CERTIFICADO DE INCAPACIDAD</div></div></div><div className="absolute top-8 right-0 w-[45%] border-[3px] border-black p-1 bg-white/90"><div className="flex justify-between font-bold"><span>NS: {data.nss}</span><span>AGREGADO MEDICO: {data.agregado}</span></div><div className="text-center font-bold mt-1">NOMBRE DEL ASEGURADO:<br/>{data.nombre}</div><div className="flex justify-between mt-1"><span>CURP: {data.curp}</span><span>SEXO:</span></div><div className="font-bold">{data.sexo}</div><div className="mt-1">DELEGACION: {data.delegacion}</div><div className="flex justify-between"><span>UNIDAD: {data.unidad}</span><span>CVE PTAL: {data.cvePtal}</span></div><div className="flex justify-between mt-1"><span className="w-1/2">CONSULTORIO: {data.consultorio}</span><span className="w-1/2">TURNO: {data.turno}</span></div><div className="mt-1">DOCUMENTO IDENTIFICACION DEL ASEGURADO: {data.documentoId}</div><div>NUMERO DE IDENTIFICACION: {data.numId}</div></div><div className="mt-20 w-1/2 mb-1"><BarcodeStrip className="h-10 w-full" /></div><div className="bg-gray-300 w-full text-right font-bold text-sm pr-2 py-0.5 border-t border-b border-gray-400 mb-0.5">Serie y Folio {data.folio}</div><div className="flex border-b-2 border-blue-300 pb-1 mb-2"><div className="w-1/4 pr-1 border-r border-gray-300"><div className="font-bold">Unidad Medica Expedidora</div><div>{data.expedidora}</div><div className="font-bold mt-2">Adscripci√≥n</div><div>{data.adscripcion}</div><div className="mt-2"><span className="font-bold">Ramo de Seguro</span> {data.ramo}</div><div><span className="font-bold">Probable Riesgo Trabajo</span> {data.probableRiesgo}</div></div><div className="w-1/4 px-1 border-r border-gray-300"><div className="font-bold">Nivel de atenci√≥n 1</div><div className="font-bold mt-2">Delegaci√≥n Adscripci√≥n</div><div>Toluca de lerdo Dias</div><div className="font-bold">Autorizados (letra)</div><div className="capitalize">{data.dias}</div></div><div className="w-1/4 px-1 border-r border-gray-300"><div className="font-bold">Delegaci√≥n Expedidora</div><div className="mt-4">3 Suroeste D.F.</div><div className="font-bold">Patr√≥n(es) MIDELPE S.A. DE C.V.</div><div className="mt-2 font-bold">N√∫mero 1 Control de Maternidad No D√≠as Acumulandos 0</div></div><div className="w-1/4 pl-1"><div className="font-bold">Certificado de Incapacidad en Serie</div><div className="font-bold text-sm mt-2">{data.folio}</div><div className="font-bold mt-1">Puesto de Trabajo:</div><div>Ayudante general</div><div className="font-bold mt-1">A partir del {data.aPartir}</div><div className="font-bold">Expedido el {data.expedido}</div></div></div><div className="text-[9px] text-justify mb-4 font-medium"><p className="font-bold mb-1">El incapacitado tiene derecho a subsidio:</p><p>a) Si se trata de un riesgo de trabajo, desde el primer d√≠a de incapacidad.</p><p>b) Si la incapacidad es causada por enfermedad no profesional a partir del 4¬∫ d√≠a de estar incapacitado...</p></div><div className="flex justify-between items-end mt-8 relative"><div className="w-1/3 text-center"><div className="border-t border-black pt-1 font-bold">Nombre y firma del m√©dico</div><div className="font-bold">{data.medico}</div><div className="text-[9px] text-blue-800 font-bold border border-blue-800 inline-block px-1 mt-1 transform -rotate-2 bg-white/80 relative z-10">IMSS Matricula: {data.matricula}</div></div><div className="w-1/3 text-center"><div className="font-bold mb-8">Matricula {data.matricula}</div><div className="font-bold text-lg">COPIA PATR√ìN</div></div><div className="w-1/3 text-center"><div className="border-t border-black pt-1 font-bold">Nombre y firma del m√©dico que autoriza</div><div>NO APLICA</div></div></div><div className="text-right mt-8 font-bold">Fecha de Impresi√≥n: {new Date().toLocaleDateString('es-MX')}</div></div><div className="absolute right-2 bottom-4 top-1/2 h-[40%] w-8 flex flex-col justify-end"><BarcodeStrip className="w-full h-full rotate-180 flex-col" /></div></div>
                        );
                    case 'cfe':
                        return (
                            <div className="paper bg-white w-[21.59cm] min-h-[13.97cm] p-0 relative text-black shadow-2xl overflow-hidden mx-auto"><div className="bg-[#007935] h-3"></div><div className="px-8 pt-4 pb-2 flex justify-between items-start border-b border-gray-200"><div className="w-1/2"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/CFE_Emblema.svg/1024px-CFE_Emblema.svg.png" className="h-12 mb-4" /><div className="text-[10px] font-bold text-gray-700 uppercase leading-snug">{data.nombre}</div><div className="text-[9px] text-gray-600 uppercase leading-snug w-[80%]">{data.direccion}</div><div className="text-[9px] text-gray-600 uppercase leading-snug">{data.ciudad}</div></div><div className="w-1/2 text-right"><div className="text-[10px] font-bold text-gray-500 uppercase">TOTAL A PAGAR:</div><div className="text-3xl font-bold text-[#007935] mb-2">${data.total} <span className="text-[10px] text-black font-normal align-top">(M.N.)</span></div><div className="grid grid-cols-2 gap-x-4 text-left text-[9px] border-t border-gray-200 pt-1"><div className="font-bold text-gray-500">NO. DE SERVICIO:</div><div className="font-bold text-right">{data.noServicio}</div><div className="font-bold text-gray-500">RMU:</div><div className="font-bold text-right truncate">{data.rmu}</div><div className="font-bold text-gray-500">L√çMITE DE PAGO:</div><div className="font-bold text-right">{data.limitePago}</div><div className="font-bold text-gray-500">CORTE A PARTIR:</div><div className="font-bold text-right text-red-600">{data.corte}</div></div></div></div><div className="px-8 py-2"><div className="flex border-b border-gray-300 pb-2"><div className="w-2/3 border-r border-gray-300 pr-4"><div className="text-[8px] font-bold text-[#007935] uppercase mb-1">CONSUMO DE ENERG√çA EL√âCTRICA</div><table className="w-full text-[8px] text-center mb-2"><thead className="bg-[#007935] text-white"><tr><th>Concepto</th><th>Lectura Actual</th><th>Lectura Anterior</th><th>Total Periodo</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody><tr><td className="border-b">Energ√≠a</td><td className="border-b font-bold">{data.lecturaActual}</td><td className="border-b font-bold">{data.lecturaAnt}</td><td className="border-b font-bold">{data.consumo}</td><td className="border-b">$1.025</td><td className="border-b font-bold">${data.subtotal}</td></tr></tbody></table><div className="h-24 w-full border border-gray-200 relative flex items-end justify-around p-2"><div className="w-4 bg-green-200 h-[40%]"></div><div className="w-4 bg-green-300 h-[60%]"></div><div className="w-4 bg-green-400 h-[30%]"></div><div className="w-4 bg-green-500 h-[50%]"></div><div className="w-4 bg-[#007935] h-[80%] relative"><div className="absolute -top-3 left-0 w-full text-center text-[6px] font-bold">{data.consumo}</div></div><div className="absolute top-1 left-2 text-[6px] text-gray-400">Historial de Consumo (kWh)</div></div></div><div className="w-1/3 pl-4"><div className="text-[8px] font-bold text-[#007935] uppercase mb-1">COSTOS DE LA ENERG√çA</div><div className="text-[8px] space-y-1 border-b border-gray-300 pb-2 mb-2"><div className="flex justify-between"><span>Suministro</span><span>$85.20</span></div><div className="flex justify-between"><span>Distribuci√≥n</span><span>$142.10</span></div><div className="flex justify-between"><span>Transmisi√≥n</span><span>$65.33</span></div><div className="flex justify-between"><span>CENACE</span><span>$12.50</span></div><div className="flex justify-between"><span>Energ√≠a</span><span>${(parseFloat(data.subtotal)-305).toFixed(2)}</span></div><div className="flex justify-between"><span>Capacidad</span><span>$0.00</span></div><div className="flex justify-between"><span>SCnMEM</span><span>$5.10</span></div></div><div className="bg-gray-100 p-2 rounded"><div className="flex justify-between text-[9px] font-bold"><span>Subtotal</span><span>${data.subtotal}</span></div><div className="flex justify-between text-[9px] font-bold"><span>IVA 16%</span><span>${data.iva}</span></div><div className="flex justify-between text-[11px] font-black text-[#007935] mt-1 border-t border-gray-300 pt-1"><span>Facturaci√≥n</span><span>${data.total}</span></div></div></div></div></div><div className="absolute bottom-0 w-full"><div className="bg-[#007935] text-white text-[8px] px-8 py-1 flex justify-between"><span>Servicio a Clientes Tel√©fono 071</span><span>www.cfe.mx</span></div><div className="px-8 py-2 flex items-center justify-between"><div className="w-2/3 h-10 flex flex-col justify-center border-t border-black pt-1"><div className="h-4 w-full bg-black/80 mb-1" style={{clipPath: 'polygon(0 0, 100% 0, 98% 100%, 2% 100%)'}}></div><div className="text-[7px] font-mono">{data.noServicio}{data.rmu.replace(/\s/g,'')}</div></div><div className="w-24 h-24 border p-1 bg-white mb-2"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(`CFE|${data.noServicio}|${data.total}|${data.limitePago}`)}`} className="w-full h-full"/></div></div></div></div>
                        );
                    case 'secondary':
                    case 'birth':
                    default:
                        // Fallback gen√©rico o plantillas adicionales (Acta y Secundaria no incluidas para brevedad pero siguen la l√≥gica)
                        return <div className="text-center p-10 bg-white rounded shadow">Vista previa no disponible para este tipo.<br/><button onClick={()=>window.print()} className="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Imprimir Datos Brutos</button></div>;
                }
            };

            // Si hay un documento seleccionado, mostramos la VISTA DE IMPRESI√ìN
            if (selectedDoc) {
                return (
                    <div className="fixed inset-0 z-[100] bg-gray-200 flex flex-col items-center overflow-auto animate-[slide_0.3s_ease-out]">
                        <div className="sticky top-0 w-full bg-white/90 backdrop-blur shadow-sm p-4 flex justify-between items-center z-50 no-print">
                            <button onClick={() => setSelectedDoc(null)} className="flex items-center gap-2 text-slate-600 font-bold hover:text-slate-900 bg-slate-100 px-4 py-2 rounded-full"><Icon name="arrow-left" size={20} /> Volver</button>
                            <h2 className="text-sm font-bold text-slate-800 uppercase tracking-widest">{selectedDoc._typeLabel}</h2>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-4 py-2 rounded-full font-bold flex items-center gap-2 hover:bg-black"><Icon name="receipt" size={18} /> Imprimir / PDF</button>
                        </div>
                        <div className="print-area p-8 pb-20 w-full flex justify-center min-h-screen">
                            <DocumentViewer data={selectedDoc} />
                        </div>
                    </div>
                );
            }

            // VISTA DE LISTA (NORMAL)
            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-8">
                    <div className="bg-slate-900 p-6 pt-12 pb-20 text-white rounded-b-[40px] shadow-lg relative z-0">
                        <button onClick={() => onNavigate('welcome')} className="absolute top-6 left-6 p-2 bg-slate-800 rounded-full hover:bg-slate-700 transition">
                            <Icon name="arrow-left" className="text-white" size={20} />
                        </button>
                        <div className="mt-4 text-center">
                            <h1 className="text-2xl font-bold">PDF Generados</h1>
                            <p className="text-slate-400 text-sm">Tus documentos guardados</p>
                        </div>
                    </div>

                    <div className="px-6 -mt-10 relative z-10 space-y-3 pb-10">
                        {loading && <div className="text-center py-10"><p className="text-slate-500 font-bold animate-pulse">Cargando historial...</p></div>}
                        
                        {!loading && docs.length === 0 && (
                            <div className="bg-white p-8 rounded-3xl shadow-sm text-center border border-slate-100">
                                <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <Icon name="box" size={32} className="text-slate-300" />
                                </div>
                                <h3 className="text-slate-800 font-bold mb-1">Sin documentos</h3>
                                <p className="text-slate-400 text-xs">Usa el bot√≥n "Guardar" en los editores para verlos aqu√≠.</p>
                            </div>
                        )}

                        {docs.map(item => (
                            <div key={item.id} onClick={() => setSelectedDoc(item)} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition cursor-pointer active:scale-95 group">
                                <div className="bg-blue-50 p-3 rounded-xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                    <Icon name={item._icon || 'file-heart'} size={24} />
                                </div>
                                <div className="flex-1 min-w-0">
                                    <div className="flex justify-between items-start">
                                        <h4 className="text-sm font-bold text-slate-800 truncate">{item._typeLabel}</h4>
                                        <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full font-bold">
                                            {formatDate(item._date)}
                                        </span>
                                    </div>
                                    <p className="text-xs text-slate-400 truncate mt-0.5">
                                        {item.nombre || item.paciente?.nombre || item.cliente?.nombre || 'Documento sin nombre'}
                                    </p>
                                    <div className="flex gap-2 mt-2">
                                        <span className="text-[10px] text-green-600 font-bold bg-green-50 px-2 py-0.5 rounded border border-green-100 flex items-center gap-1">
                                            <Icon name="shield" size={10}/> Toca para Descargar
                                        </span>
                                    </div>
                                </div>
                                <div className="text-slate-300 group-hover:text-blue-500"><Icon name="chevron-right" size={20} /></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };


        const App = () => {
            const [screen, setScreen] = useState('loading');
            const [user, setUser] = useState(null);

            useEffect(() => {
                const loader = document.getElementById('loader-wrapper');
                const unsub = auth.onAuthStateChanged(u => {
                    setTimeout(() => {
                        if(document.getElementById('loader-wrapper')) {
                             document.getElementById('loader-wrapper').classList.add('fade-out');
                             document.body.classList.add('app-loaded');
                        }
                        if(u && (u.emailVerified || u.email === ADMIN_EMAIL)) { setUser(u); setScreen('welcome'); } 
                        else { setUser(null); setScreen('auth'); }
                    }, 2000);
                });
                return () => unsub();
            }, []);

            return (
                <>
                    {screen === 'auth' && <AuthScreen onLoginSuccess={u => { setUser(u); setScreen('welcome'); }} />}
                    {screen === 'welcome' && <WelcomeScreen onNavigate={setScreen} onLogout={() => { auth.signOut(); setScreen('auth'); }} user={user} />}
                    {screen === 'services' && <ServicesMenu onNavigate={setScreen} user={user} />}
                    
                    {screen === 'editor' && <RecipeEditor onNavigate={setScreen} user={user} />}
                    {screen === 'note_editor' && <NoteEditor onNavigate={setScreen} user={user} />}
                    {screen === 'acta_editor' && <BirthCertificateEditor onNavigate={setScreen} user={user} />}
                    {screen === 'curp_editor' && <CurpEditor onNavigate={setScreen} user={user} />}
                    {screen === 'incapacity_editor' && <IncapacityEditor onNavigate={setScreen} user={user} />}
                    {screen === 'cfe_editor' && <CfeEditor onNavigate={setScreen} user={user} />}
                    {screen === 'secundaria_editor' && <SecondaryCertificateEditor onNavigate={setScreen} user={user} />}
                    {screen === 'ine_editor' && <IneEditor onNavigate={setScreen} user={user} />}
                    
                    {screen === 'generated_pdfs' && <GeneratedDocsScreen onNavigate={setScreen} user={user} />} 

                    {screen === 'history' && <HistoryScreen onNavigate={setScreen} user={user} />}
                    {screen === 'admin' && <AdminPanel onNavigate={setScreen} />}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
